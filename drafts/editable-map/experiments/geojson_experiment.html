<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Test</title>

  <!-- Leaflet CDN -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css"
    integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ=="
    crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"
    integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ=="
    crossorigin=""></script>
  <script src="helper_functions.js"></script>

  <style>
    #map {
      position: relative;
      width: 100%;
      height: 500px;
      left: 0;
      top: 0;
    }

  </style>
    
</head>

<body>

  <!-- 
    https://commons.wikimedia.org/wiki/Category:SVG_arrow_icons:_Noun_project
    https://commons.wikimedia.org/wiki/File:Download_(4501)_-_The_Noun_Project.svg
    https://commons.wikimedia.org/wiki/File:Download_(89523)_-_The_Noun_Project.svg,
    https://commons.wikimedia.org/wiki/File:Noun_project_-_Upload.svg
    https://commons.wikimedia.org/wiki/File:Upload_(89524)_-_The_Noun_Project.svg
  -->

  <div id="map"></div>

  <script>
  // reference: https://leafletjs.com/examples/geojson/

    // create map
    const map = L.map("map", {
      center: [41.783, -87.621],
      zoom: 5,
    });

    // add tiles to map
    const tiles = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "Â© OpenStreetMap"
    }).addTo(map);

    let geojsonLayerRef = null;

    // data structure to track markerRecords
    const markerRecords = new Map();

    // create marker layer
    const markerLayerGroup = L.layerGroup().addTo(map);

    var geojsonLayer = L.geoJSON(
      null,
      {
        pointToLayer: (point, latlng) => {
          const marker = L.marker(latlng);
          console.log("in pointToLayer: " + JSON.stringify(latlng));
          geojsonLayerRef = marker;
          return marker;
        },
        onEachFeature: (feature, layer) => {
          if (feature.properties && feature.properties.label) {
            layer.bindPopup(feature.properties.label);
          } else {
            layer.bindPopup("no label");
          }
        },
      }
    ).addTo(map);

    /**
     * Function to run whenever the map is clicked.
     */
    function onMapClick(event) {
      const latlngString = JSON.stringify(event.latlng);
      // if a marker with these coordinates has already been added to the map, open its popup
      // otherwise, add a marker to the map at these coordinates
      if (markerRecords.has(latlngString)) {
        markerRecords.get(latlngString).markerReference.openPopup();
      } else {
        const popup = L.popup({
          keepInView : true,
          closeButton : false,
          autoClose : false,
          closeOnEscapeKey : false,
          closeOnClick : false,
        });
        // create marker
        const marker = L.marker(event.latlng);
        //markerRecords.set(latlngString, getDefaultMarkerRecord(marker));
        popup.setContent(latlngString);
        marker
          .bindPopup(popup)
          .addTo(map);
        console.log("non-geojson: " + latlngString);
        var geojson = marker.toGeoJSON(false);
        marker.removeFrom(map);
        console.log("removed");
        console.log(JSON.stringify(geojson));
        geojson.properties.label = "Test";
        console.log(JSON.stringify(geojson));
        geojsonLayer.addData(geojson);
        console.log("added");
        geojsonLayer.removeLayer(geojsonLayerRef);
        console.log("removed");
      }
    }

    // add click event listener to map
    map.on("click", onMapClick);
    
    /*document.getElementById("controlButtons").appendChild(createButton("Clear markerRecords", () => {
      // also reset markerRecords set
      markerLayerGroup.clearLayers();
      markerRecords.clear();
      console.log("markerLayerGroup cleared");
    }));*/

    // TODO: consider making markerRecords draggable (would have to add "move" event listener)
  </script>   

</body>

</html>
<!-- references:
  https://github.com/Leaflet/Leaflet/tree/main/docs/examples (BSD 2-Clause license)
  https://stackoverflow.com/a/59052053 (CC BY-SA 4.0 license)
-->
