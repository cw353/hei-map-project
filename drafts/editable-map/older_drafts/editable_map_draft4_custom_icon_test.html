<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Editable Map</title>

  <!-- Leaflet CDN -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css"
    integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ=="
    crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"
    integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ=="
    crossorigin=""></script>
  <script src="helper_functions.js"></script>

  <style>
    #map {
      position: relative;
      width: 100%;
      height: 700px;
      left: 0;
      top: 0;
    }

    .green_icon path {
      fill: green;
    }

  </style>
    
</head>

<body>

  <div id="controlButtons"></div>
  <div id="map"></div>

  <script>

    // create map
    const map = L.map("map", {
      center: [41.783, -87.621],
      zoom: 14,
    });

    // add tiles to map
    const tiles = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "Â© OpenStreetMap"
    }).addTo(map);

    // data structure to track markers
    const markers = new Map();

    // create marker layer
    const markerLayerGroup = L.layerGroup().addTo(map);
    
    /**
     * Generate a custom icon with the specified fill color.
     * The icon is based on https://commons.wikimedia.org/wiki/File:Octicons-location.svg (MIT license).
     * Resources referenced: https://onestepcode.com/leaflet-markers-svg-icons/.
     * @param color The fill color.
     * @returns The custom icon with the specified fill color.
     */
    function generateIcon(color) {
      return L.divIcon({
        className: "custom_divicon",
        iconSize: [25, 50],
        html:
          `<svg
            width="25"
            height="50"
            viewBox="0 0 640 1024"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M320 0c-177 0-320 143-320 320s160 416 320 704c160-288 320-527 320-704s-143-320-320-320z m0 448c-71 0-128-57-128-128s57-128 128-128 128 57 128 128-57 128-128 128z"
              fill=${color}
            />
          </svg>`
      });
    }

    const testmarker = L.marker([41.783, -87.621], {icon : generateIcon("red")}).addTo(map);
    //testmarker.setIcon(generateIcon("green"));
    //testmarker._icon.classList.replace("test", "green_icon");
    /*console.log(testmarker._icon.classList);
    testmarker.getIcon().setAttribute(
      "style",
      testmarker.getIcon().getAttribute("style") + " fill: blue;"
    );
    console.log(testmarker._icon.getAttribute("style"));*/
    /*testmarker._icon.setAttribute(
      "style",
      testmarker._icon.getAttribute("style").replace("fill: gray", "fill: blue")
    );
    console.log(testmarker._icon.getAttribute("style"));*/

    function getEditMarkerUI(popup) {
      const markerRecord = {
        "color" : "#e66465",
        "label" : "Placeholder Label",
        "description" : "This is a sample description.",
      }; // placeholder for development
      // form for editing the marker
      return createElement({
        type: "form",
        attributes: [["id", "editMarkerForm"]],
        children: [
          createElement({
            type: "p",
            children: [
              // input for editing marker label
              createElement({
                type: "label",
                text: "Edit label: ",
                children: [
                  createElement({
                    type: "input",
                    attributes: [
                      ["id", "editMarkerLabel"], ["type", "text"],
                      ["value", markerRecord.label], // populate input with current label
                    ],
                  })
                ],
              })
            ]
          }),
          createElement({
            type: "p",
            children: [
              // input for editing marker color
              createElement({
                type: "label",
                text: "Edit color: ",
                children: [
                  createElement({
                    type: "input",
                    attributes: [
                      ["id", "editMarkerColor"], ["type", "color"],
                      ["value", markerRecord.color], // populate input with current label
                    ],
                  })
                ],
              })
            ]
          }),
          createElement({
            type: "p",
            children: [
              // textarea for editing marker description
              createElement({
                type: "label",
                text: "Edit description:",
                children: [
                  createElement({
                    type: "textarea",
                    text: markerRecord.description, // populate textarea with current description
                    attributes: [["id", "editMarkerDescription"], ["rows", "5"], ["cols", "30"]],
                  })
                ],
              }),
            ],
          }),
          createButton("Cancel", () => map.closePopup(popup)),
          createButton("Save", () => map.closePopup(popup)),
        ]
      });
    }

    /**
     * Function to run whenever the map is clicked.
     */
    function onMapClick(event) {
      const latlngString = JSON.stringify(event.latlng);
      // if a marker with these coordinates has already been added to the map, open its popup
      // otherwise, add a marker to the map at these coordinates
      if (markers.has(latlngString)) {
        markers.get(latlngString).markerObject.openPopup();
      } else {
        const popup = L.popup({
          keepInView : true,
          /*closeButton : false,
          autoClose : false,
          closeOnEscapeKey : false,
          closeOnClick : false,*/
        });
        popup.setContent(getEditMarkerUI(popup));
        // create marker
        const marker = L.marker(event.latlng) // create a new marker
          .bindPopup(popup) // add popup
          .addTo(markerLayerGroup) // add to layer group (and map)
          .openPopup();
        // add marker to map
        markers.set(latlngString, {
          markerObject: marker,
          label: null,
          description: null,
        });
      }
    }

    // add click event listener to map
    //map.on("click", onMapClick);
    
    document.getElementById("controlButtons").appendChild(createButton("Clear Markers", () => {
      // also reset markers set
      markerLayerGroup.clearLayers();
      markers.clear();
      console.log("markerLayerGroup cleared");
    }));

    // TODO: consider making markers draggable (would have to add "move" event listener)
  </script>   

</body>

</html>
<!-- references:
  https://github.com/Leaflet/Leaflet/tree/main/docs/examples (BSD 2-Clause license)
  https://stackoverflow.com/a/59052053 (CC BY-SA 4.0 license)
-->
