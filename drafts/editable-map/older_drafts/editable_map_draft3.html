<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Editable Map</title>

  <!-- Leaflet CDN -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css"
    integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ=="
    crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"
    integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ=="
    crossorigin=""></script>

  <style>
    #map {
      position: relative;
      width: 100%;
      height: 700px;
      left: 0;
      top: 0;
    }
  </style>
    
</head>

<body>

  <div id="exportDiv">
  </div>
  <div id="map"></div>

  <script>

    const markers = new Set();

    /**
     * Helper function to create a button with the specified text and click event handler.
     * @param text The text for the button.
     * @param onClick The click event handler for the button.
     * @returns The button.
     */
    function createButton(text, onClick) {
      const b = document.createElement("button");
      b.appendChild(document.createTextNode(text));
      b.addEventListener("click", onClick);
      return b;
    }

    // create map
    const map = L.map("map", {
      center: [41.783, -87.621],
      zoom: 5,
    });

    // add tiles to map
    const tiles = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "Â© OpenStreetMap"
    }).addTo(map);

    // allow editing of markers after creation?
    function getMarkerPopup(markerRecord, marker) {
      const contentDiv = document.createElement("div");
      contentDiv.appendChild(document.createTextNode(markerRecord.label));
      contentDiv.appendChild(createButton("Remove", () => {
        markers.delete(markerRecord);
        console.log(JSON.stringify([...markers]));
        marker.removeFrom(map);
      }));
      return contentDiv;
    }

    function onMapClick(e) {
      const markerLabelInput = document.createElement("input");
      markerLabelInput.setAttribute("type", "text");
      const onClickPopup = L.popup({
        keepInView: true, // prevent user from panning the popup out of view
      });
      // Add marker button
      const cancelButton = createButton("Cancel", () => {
        map.closePopup(onClickPopup);
      });
      const addMarkerButton = createButton("Add Marker", () => {
        map.closePopup(onClickPopup);
        markerRecord = {
          latlng: e.latlng,
          label: markerLabelInput.value,
        };
        markers.add(markerRecord);
        console.log(JSON.stringify([...markers]));
        const marker = L.marker(e.latlng)
          .addTo(map);
        marker.bindPopup(getMarkerPopup(markerRecord, marker));
      });

      const promptDiv = document.createElement("div");
      promptDiv.appendChild(document.createTextNode("Add a marker to the map at this location"))
      promptDiv.appendChild(markerLabelInput);
      promptDiv.appendChild(cancelButton);
      promptDiv.appendChild(addMarkerButton);

      onClickPopup
        .setLatLng(e.latlng)
        .setContent(promptDiv)
        .openOn(map);
    }

    map.on("click", onMapClick);

    // Based on https://stackoverflow.com/a/18197341 (CC BY-SA 3.0 license)
	// See also https://stackoverflow.com/questions/34156282/how-do-i-save-json-to-local-text-file
    function exportMarkers() {
      let downloadLink = document.createElement("a");
      downloadLink.setAttribute("href", "data:text/plain;charset=utf-8," + encodeURIComponent(
        JSON.stringify([...markers])
      ));
      downloadLink.setAttribute("download", "markers.json");
      downloadLink.click();
    }

    document.getElementById("exportDiv").appendChild(createButton("Export Markers", exportMarkers));

  </script>   

</body>

</html>
<!-- reference: https://github.com/Leaflet/Leaflet/tree/main/docs/examples (BSD 2-Clause License) -->
