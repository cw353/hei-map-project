<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="author" content="Claire Wagner (Summer 2022 Wheaton College Research Team)">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Map of Properties of Interest to HEI</title>

  <!-- Leaflet CDN -->
  <!--link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css"
    integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ=="
    crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"
    integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ=="
    crossorigin=""></script-->

  <!-- Leaflet.markercluster CDN -->
  <!--link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css"
    integrity="sha512-RLEjtaFGdC4iQMJDbMzim/dOvAu+8Qp9sw7QE4wIMYcg2goVoivzwgSZq9CsIxp4xKAZPKh5J2f2lOko2Ze6FQ=="
    crossorigin=""/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css"
    integrity="sha512-BBToHPBStgMiw0lD4AtkRIZmdndhB6aQbXpX7omcrXeG2PauGBl2lzq2xUZTxaLxYz5IDHlmneCZ1IJ+P3kYtQ=="
    crossorigin=""/>
  <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"
    integrity="sha512-MQlyPV+ol2lp4KodaU/Xmrn+txc1TP15pOBF/2Sfre7MRsA/pB4Vy58bEqe9u7a7DczMLtU5wT8n7OblJepKbg=="
    crossorigin=""></script-->

  <!-- Leaflet.MarkerCluster.LayerSupport CDN -->
  <!--script src="https://unpkg.com/leaflet.markercluster.layersupport@2.0.1/dist/leaflet.markercluster.layersupport.js"
    integrity="sha512-Utd3nyu+vSSF4E6z/hcIzoi2mCedtng1MTF2sZWLnlL2BCwSyyvwT2otaWEiVmkgCpfTy6C/RVxo5WIoJ9zY3Q=="
    crossorigin=""></script-->
  
  <!-- jQuery -->
  <!--script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"
    integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ=="
    crossorigin=""></script-->

  <!-- Local copies of Leaflet plugin scripts and stylesheets -->
  <link rel="stylesheet" href="libraries/leaflet/leaflet.css"/>
  <script src="libraries/leaflet/leaflet-src.js"></script>
  <link rel="stylesheet" href="libraries/leaflet/plugins/MarkerCluster/MarkerCluster.css"/>
  <link rel="stylesheet" href="libraries/leaflet/plugins/MarkerCluster/MarkerCluster.Default.css"/>
  <script src="libraries/leaflet/plugins/MarkerCluster/leaflet.markercluster-src.js"></script>
  <script src="libraries/leaflet/plugins/MarkerClusterLayerSupport/layersupport.js"></script>
  <link rel="stylesheet" href="libraries/leaflet/plugins/ControlLayersTree/L.Control.Layers.Tree.css"/>
  <script src="libraries/leaflet/plugins/ControlLayersTree/L.Control.Layers.Tree.js"></script>
  <script src="libraries/jquery-3.6.0.js"></script>

  <!-- External files for stylesheets, functions, and data -->
  <link rel="stylesheet" href="code/map_stylesheet.css"/>
    
</head>

<body>

  <div id="pageContent">
    <div id="pageHeader"></div>
    <div id="tabDiv"></div>
    
    <div id="mapTab">
      <div id="searchBarDiv">
        <label>
          Search for a PIN on the map:
        <!-- at least 14 digits, optionally separated by - or whitespace -->
          <input id="searchInput" type="search" inputmode="numeric" pattern="([\s-]*\d[\s-]*){14}"/>
        </label>
        <button type="button" id="searchButton">Search</button>
        <span id="searchResultsSpan"></span>
      </div>
      <div id="additionalMapControlsContainer" class="formContainer">
        <div id="additionalMapControls">
          <div id="highlightSelectDiv"></div>
          <div id="radiiInputDiv"></div>
        </div>
      </div>
      <div id="map"></div>
    </div>

    <div id="favoritedPinsTab">Favorited PINs content will be added later...</div>
    <div id="aboutMapTab">
      <div id="datasetTableDiv" class="center"></div>
    </div>

  </div>

  </div>

  <img id="loadingIcon" src="https://upload.wikimedia.org/wikipedia/commons/2/28/InternetSlowdown_Day.gif" alt="loading icon (Darmokand, CC BY-SA 4.0 license)"/>

  <script>
    $("#pageContent").hide();
  </script>

  <script src="code/map_functions.js"></script>
  <script src="code/map_classes.js"></script>
  <script src="data/geojson/ward_boundaries.js"></script>
  <script src="data/geojson/neighborhood_boundaries.js"></script>
  <!--script src="data/geojson/zoning_districts.js"></script-->
  <script src="data/misc/misc.js"></script>
  <script src="data/misc/individual_properties.js"></script>
  <script src="data/city-owned/city_owned_data.js"></script>
  <script src="data/tax-sale/tax_sale_ward20_tax_year_2019.js"></script>
  <script src="data/scavenger-sale/scavenger_data.js"></script>
  <!--script src="data/business-licenses/business_license_data.js"></script-->

  <script>

    console.log("Starting inline script...");

    $("#pageHeader").html(`<h1>${document.title}</h1>`);

    const useLocalStorage = false;

    // create map
    const map = L.map("map", {
      center: [41.783, -87.621],
      zoom: 12,
      scrollWheelZoom: false,
      doubleClickZoom: false,
    });

    // add tiles to map - reference: https://leafletjs.com/examples/layers-control/
    const osmtiles = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "&copy; <a href='http://www.openstreetmap.org/copyright' target='_blank' rel='noopener'>OpenStreetMap</a>",
    }).addTo(map);

    // marker cluster support group for all clusterable markers
    const markerClusterSupportGroup = L.markerClusterGroup.layerSupport({
      maxClusterRadius: 50,
    }).addTo(map);

    // popup that describes marker cluster content when user mouses over marker cluster
    markerClusterSupportGroup.on("clustermouseover", (a) => {
      a.layer.bindPopup(
        getMarkerClusterPopupContent(a.layer.getAllChildMarkers()),
		{ maxHeight: 200, },
      ).openPopup();
    });
    markerClusterSupportGroup.on("clustermouseout", (a) => {
      a.layer.closePopup();
    });

    const wardHighlightSelect = new HighlightSelect(
      "Choose a ward to highlight: ",
      (props, comparand) => { return "ward" in props && ("Ward " + props.ward) === comparand },
    );
    for (let i = 1; i < 51; i++) { wardHighlightSelect.addOption("Ward " + i); }

    const neighborhoodHighlightSelect = new HighlightSelect(
      "Choose a neighborhood to highlight: ",
      (props, comparand) => { return "pri_neigh" in props && props.pri_neigh === comparand },
    );

    const zoneClassHighlightSelect = new HighlightSelect(
      "Choose a zone class to highlight: ",
      (props, comparand) => { return "zone_class" in props && props.zone_class.startsWith(comparand); },
    );

    // add geographic boundaries
    const geoBoundaries = new Datagroup("Geographic Boundaries");
    geoBoundaries.addChildLayer(new BoundaryLayerInfo(
      "Ward Boundaries (2015&ndash;2023)",
      ward_boundaries_2015_to_2023.data,
      ward_boundaries_2015_to_2023.metadata.attribution ? ward_boundaries_2015_to_2023.metadata.attribution : "City of Chicago",
      {
        getTooltipText: (props) => { return `Ward ${props.ward} (2015&ndash;2023)`; },
        highlightFunction: wardHighlightSelect.highlightFunction,
      },
    ));
    geoBoundaries.addChildLayer(new BoundaryLayerInfo(
      "Ward Boundaries (2023+)",
      ward_boundaries_2023.data,
      ward_boundaries_2023.metadata.attribution ? ward_boundaries_2023.metadata.attribution : "City of Chicago",
      {
        getTooltipText: (props) => { return `Ward ${props.ward} (2023+)`; },
        highlightFunction: wardHighlightSelect.highlightFunction,
      },
    ));
    geoBoundaries.addChildLayer(new BoundaryLayerInfo(
      "Neighborhood Boundaries",
      neighborhood_boundaries.data,
      neighborhood_boundaries.metadata.attribution ? neighborhood_boundaries.metadata.attribution : "City of Chicago",
      {
        getTooltipText: (props) => { return props.pri_neigh; },
        highlightFunction: neighborhoodHighlightSelect.highlightFunction,
        onEachFeature: (feature) => { neighborhoodHighlightSelect.addOption(feature.properties.pri_neigh); },
      },
    ));
    /*const zoneClassRegex = new RegExp("^[A-Z]+");
    geoBoundaries.addChildLayer(new BoundaryLayerInfo(
      "Zoning Districts",
      zoning_districts.data,
      zoning_districts.metadata.attribution ? zoning_districts.metadata.attribution : "City of Chicago",
      {
        getTooltipText: (props) => { return props.zone_class; },
        highlightFunction: zoneClassHighlightSelect.highlightFunction,
        onEachFeature: (feature) => { zoneClassHighlightSelect.addOption(zoneClassRegex.exec(feature.properties.zone_class)[0]); }, // add alphabetic zone class prefix
      }
    ));*/
    geoBoundaries.addChildLayer(new LayerInfo("No Boundaries", null, L.layerGroup(), false));
    map.addLayer(geoBoundaries.getChildLayer("Ward Boundaries (2015&ndash;2023)").layer);

    function getWard(ward) {
      return ward === 20 ? "Ward 20"
        : ward <= 10 ? "Wards 1&ndash;10"
        : ward < 20 ? "Wards 11&ndash;19"
        : ward <= 30 ? "Wards 21&ndash;30"
        : ward <= 40 ? "Wards 31&ndash;40"
        : ward <= 50 ? "Wards 41&ndash;50"
        : "Unknown Ward";
    }

    const sunshineGospel = new MarkerAndCircleDatagroupNew(
      "Sunshine Gospel Ministries",
      new Dataset(sunshine_gospel, property_locations_metadata.attribution, "pin"),
      {
        markerColor: "#ff66ff",
        circleColor: "#ff80ff",
        //getMarkerLayer: (attribution) => getCheckedInLayer(markerClusterSupportGroup, { attribution: attribution }),
        markerPopupContent: "<a href='https://www.sunshinegospel.org/' target='_blank' rel='noopener'>Sunshine Gospel Ministries</a>",
      },
    );
    /*sunshineGospel.getData = function(identifier) {
      return identifier === this.data.pin.toString() ? this.data : undefined;
    }*/

    const ward20Office = new MarkerAndCircleDatagroupNew(
      "Ward 20 Office",
      new Dataset(ward_20_office, ward_offices_metadata.attribution, "ward"),
      {
        markerColor: "#0099ff",
        circleColor: "#00ace6",
        //getMarkerLayer: (attribution) => getCheckedInLayer(markerClusterSupportGroup, { attribution: attribution }),
        markerPopupContent: "<a href='https://www.chicago.gov/city/en/about/wards/20.html' target='_blank' rel='noopener'>Ward 20 Office</a>",
      },
    );

    const cityOwned = new ClassifiableMarkerDataDatagroup(
      "City-Owned PINs (Possibly for Sale)",
      new Dataset(city_owned_data, city_owned_metadata.attribution + " & " + property_locations_metadata.attribution, "pin"),
      (data) => { return ("ward" in data) ? getWard(data.ward) : "Unknown Ward" },
      function(data) { return getMarkerPopupContent(data, this, [
        { label: "PIN", data: data.pin },
        { label: "Address", data: data.property_address },
        { label: "Ward", data: data.ward },
        { label: "Property Status", data: data.property_status },
        { label: "Record Last Updated", data: data.last_update },
        { label: "Property Details", data: getPropertyDetailsLink(data.pin) }
      ]); },
      {
        getColor: getNextColor,
        getNewLayer: (attribution) => getCheckedInLayer(markerClusterSupportGroup, { attribution: attribution }),
        trackMarkerCount: true,
      },
    );

    const ward20TaxSale = new ClassifiableMarkerDataDatagroup(
      "Ward 20 Tax Sale",
      new Dataset(taxsale_ward20_data, taxsale_ward20_metadata.attribution + " & " + property_locations_metadata.attribution, "pin"),
      (data) => { return ("classification" in data) ? data.classification : "Unclassified" },
      function(data) { return getMarkerPopupContent(data, this, [
        { label: "PIN", data: data.pin },
        { label: "Address", data: data.property_address },
        { label: "Ward", data: data.ward },
        { label: "Classification", data: data.classification },
        { label: "2019 Tax Due (Including Interest)", data: `$${data.total_due_including_interest}` },
        { label: "2019 Tax Due (Excluding Interest)", data: `$${data.total_tax_due}` },
        { label: "Property Details", data: getPropertyDetailsLink(data.pin) },
      ]); },
      {
        getColor: getNextColor,
        getNewLayer: (attribution) => getCheckedInLayer(markerClusterSupportGroup, { attribution: attribution }),
        trackMarkerCount: true,
      },
    );

    const scavengerSale = new ClassifiableMarkerDataDatagroup(
      "Scavenger Sale 2022",
      new Dataset(scavenger_sale_data, scavenger_sale_metadata.attribution + " & " + property_locations_metadata.attribution, "pin"),
      (data) => { return "property_code_class" in data ? data.property_code_class : "Unclassified" },
      function(data) { return getMarkerPopupContent(data, this, [
        { label: "PIN", data: data.pin },
        { label: "Address", data: data.property_address },
        { label: "Ward", data: data.ward },
        { label: "Classification", data: data.property_code_meaning },
        { label: "Delinquent Tax", data: `$${data.delinquent_tax}` },
        { label: "Delinquent Interest", data: `$${data.delinquent_interest}` },
        { label: "Property Details", data: getPropertyDetailsLink(data.pin) },
      ]); },
      {
        getColor: getNextColor,
        getNewLayer: (attribution) => getCheckedInLayer(markerClusterSupportGroup, { attribution: attribution }),
        trackMarkerCount: true,
      },
    );

    /*const businessLicenses = new ClassifiableMarkerDataDatagroup(
      "Business Licenses",
      new Dataset(business_license_data, business_licenses_metadata.attribution, "license_number"),
      (data) => { return ("ward" in data) ? getWard(data.ward) : "Unknown Ward" },
      function(data) { return getMarkerPopupContent(data, this, [
        { label: "Business", data: data.doing_business_as_name },
        { label: "Address", data: data.address },
        { label: "Ward", data: data.ward },
        { label: "License Number", data: data.license_number },
        { label: "License Description", data: data.license_description },
        { label: "Business Activity", data: data.business_activity },
      ]); },
      {
        getColor: getNextColor,
        getNewLayer: (attribution) => getCheckedInLayer(markerClusterSupportGroup, { attribution: attribution }),
        trackMarkerCount: true,
      },
    );*/

    const userAddedMarkers = new ClassifiableMarkerDataDatagroup(
      "User-Added Markers",
      new Dataset({}, property_locations_metadata.attribution, "pin"),
      null, // markers added to this datagroup should be manually classified
      function(data) { return getMarkerPopupContent(data, this, [
        { label: "PIN", data: data.pin },
        { label: "Address", data: data.property_address },
        { label: "Zip Code", data: data.property_zip },
        { label: "City", data: data.property_city },
        { label: "Ward", data: data.ward },
        { label: "Property Details", data: getPropertyDetailsLink(data.pin) },
      ]); },
    );
    userAddedMarkers.addChildLayer(
      new LayerInfo(
        "Search Results",
        "red",
        getCheckedInLayer(markerClusterSupportGroup, { attribution: property_locations_metadata.attribution }),
        false,
      )
    );
    if (useLocalStorage) {
      const previousUserAddedPins = localStorage.getItem("hei-map-user-added-pins");
      previousUserAddedPins && JSON.parse(previousUserAddedPins).forEach((pin) => {
        getDataByPinViaAjax(
          pin,
          (data) => {
            if (data.length < 1) {
              console.log("Error: no data found for user-added PIN " + pin);
            } else {
              addSearchResultToMap(data[0], false);
            }
        });
      });
    }

    const datagroups = [cityOwned, ward20TaxSale, scavengerSale, userAddedMarkers];
    const datagroupOverlays = [];
    for (const datagroup of datagroups) {
      datagroupOverlays.push(getDatagroupOverlaySubtree(
        datagroup,
        {
          selectAllCheckbox: true,
          sort: true,
          collapsed: true,
        }
      ));
    }

    // add overlay control tree
    const baseTree = {
      label: "Base Layers",
      children: [
        { label: "Open StreetMap", layer: osmtiles },
      ]
    };

    const overlayTree = {
      label: getParentOverlayLabel("Map Layers"),
      selectAllCheckbox: false,
      children: [
        getDatagroupOverlaySubtree(geoBoundaries, {
          radioGroupName: "geoboundaries",
          selectAllCheckbox: false,
        }),
        getDatagroupOverlaySubtree(ward20Office, { selectAllCheckbox: true }),
        getDatagroupOverlaySubtree(sunshineGospel, { selectAllCheckbox: true }),
        ...datagroupOverlays,
      ],
    };

    const layerControlTree = L.control.layers.tree(
      baseTree,
      overlayTree,
      {
        collapsed : false,
        hideSingleBase: true,
      }
    ).addTo(map);

    // add marker cluster legend to map (reference: https://leafletjs.com/examples/choropleth/)
    const legend = L.control({position: "bottomleft"});
    legend.onAdd = function(map) {
      const rangeBounds = [1, 10, 100];
      const colors = ["rgba(110, 204, 57, 0.8)", "rgba(240, 194, 12, 0.6)", "rgba(241, 128, 23, 0.8)"];
      const div = L.DomUtil.create("div", "legend");
      div.innerHTML = "<header>Marker Clusters</header>";
      for (let i = 0; i < rangeBounds.length; i++) {
        div.innerHTML += `<p><i style="background-color: ${colors[i]}"></i> ${rangeBounds[i]}` + (rangeBounds[i+1] ? `&ndash;${rangeBounds[i+1]} properties<br>` : "+ properties</p>");
      }
      return div;
    }
    legend.addTo(map);

    const highlightSelectItems = [
      { highlightSelect: wardHighlightSelect, sort: false, layerNames: ["Ward Boundaries (2015&ndash;2023)", "Ward Boundaries (2023+)"] },
      { highlightSelect: neighborhoodHighlightSelect, sort: true, layerNames: ["Neighborhood Boundaries"] },
      //{ highlightSelect: zoneClassHighlightSelect, sort: true, layerNames: ["Zoning Districts"] },
    ];
    const highlightSelectDiv = $("#highlightSelectDiv");
    for (const item of highlightSelectItems) {
      highlightSelectDiv.append(
        $("<div></div>").addClass("formContainer")
          .append(item.highlightSelect.getHighlightSelectElement(item.sort, item.layerNames.map((layerName) => geoBoundaries.getChildLayer(layerName))))
      );
    }

    const radiiInputItems = [ward20Office, sunshineGospel];
    const radiiInputDiv = document.getElementById("radiiInputDiv");
    for (const item of radiiInputItems) {
      radiiInputDiv.appendChild(item.getRadiusInputElement());
    }

    const additionalMapControlsDiv = $("#additionalMapControls");
    getToggleVisibilityButton(
      additionalMapControlsDiv, "+ Show Additional Map Controls", "- Hide Additional Map Controls", false,
    )
    .insertBefore(additionalMapControlsDiv.hide());

    $("#tabDiv").append(getTabs([
      { label: "Map", tabContent: $("#mapTab"), callback: () => map.invalidateSize(), initiallyActive: true },
      { label: "About This Map", tabContent: $("#aboutMapTab"), },
      { label: "Favorited PINs", tabContent: $("#favoritedPinsTab"), },
    ]));

    $("#aboutMapTab")
      .append(
        "<p id='mapDescription'>This is a map of properties that may be of interest to Sunshine Gospel Ministries'"
        + " Housing Equity Initiative (HEI). This map was created by the Wheaton College 2022"
        + " Summer Research Team.</p>"
      )
      .append(generateMetadataTable(
        "Data Used in This Map",
        [
          property_locations_metadata,
          ward_offices_metadata,
          city_owned_metadata,
          taxsale_ward20_metadata,
          scavenger_sale_metadata,
          property_classification_codes_metadata,
          //business_licenses_metadata,
          ward_boundaries_2015_to_2023.metadata,
          ward_boundaries_2023.metadata,
          neighborhood_boundaries.metadata,
          //zoning_districts.metadata,        
        ],
      ));

      function getDataByPinViaAjax(pin, done, fail, always) {
        const jqxhr = $.ajax({
          url: "https://datacatalog.cookcountyil.gov/resource/c49d-89sn.json",
          type: "GET",
          data: {
            "$query" : `SELECT pin, property_address, property_zip, property_city, ward, latitude, longitude WHERE (pin = '${pin}') AND (latitude IS NOT NULL) AND (longitude IS NOT NULL) LIMIT 1`,
          },
          datatype: "json",
        });
        done && jqxhr.done(done);
        fail && jqxhr.fail(fail);
        always && jqxhr.always(always);
      }

      function showMarker(markerData, callback) {
        const marker = markerData.marker;
        const layer = markerData.layerInfo.layer;
        if (!map.hasLayer(layer)) {
          map.addLayer(layer);
        }
        markerClusterSupportGroup.zoomToShowLayer(
          marker,
          () => { 
            marker.openPopup();
            callback && callback();
          },
        );
      }

      function addSearchResult(data, updateLocalStorage) {
        const dataset = userAddedMarkers.dataset;
        const identifier = data[dataset.identifierField];
        dataset.data[identifier] = data;
        userAddedMarkers.addMarker(
          identifier,
          data,
          userAddedMarkers.getChildLayer("Search Results"),
          userAddedMarkers.getPopupContent(data),
        );
        updateLocalStorage && localStorage.setItem(
          "hei-map-user-added-pins",
          JSON.stringify(Object.keys(userAddedMarkers.dataset)),
        );
        return userAddedMarkers.getMarkerData(identifier);
      }

      const searchInput = document.getElementById("searchInput");
      const searchResultsSpan = $("#searchResultsSpan");
      $("#searchButton").on("click", () => {
        searchResultsSpan.html("");
        if (searchInput.validity.patternMismatch || searchInput.value === "") {
          searchInput.setCustomValidity("Please enter a valid 14-digit PIN.");
          searchInput.reportValidity();
        } else {
          searchInput.setCustomValidity("");
          const pin = searchInput.value.replace(/[-\s]/g,"");
          const searchResults = searchDatagroupsForIdentifierNew(
            pin,
            [ cityOwned, ward20TaxSale, scavengerSale, userAddedMarkers, sunshineGospel, ],
          );
          const numberOfResults = Object.keys(searchResults).length;

          if (numberOfResults < 1) {
            if (window.confirm("This PIN is not on the map. Add a new marker to the map for this PIN?")) {
              getDataByPinViaAjax(
                pin,
                (data) => {
                  if (data.length < 1) {
                    searchResultsSpan.text("No data could be found for this PIN.");
                  } else {
                    const finalSearchResult = addSearchResult(data[0], useLocalStorage);
                    showMarker(finalSearchResult, () => { searchResultsSpan.html("A new marker for this PIN has been added to the map."); });
                  }
                },
                (jqxhr, textStatus) => { console.log(`Failed to retrieve data for PIN ${pin}: ${textStatus}`); },
              );
            }
          } else if (numberOfResults === 1) {
            const finalSearchResult = Object.values(searchResults)[0];
            searchResultsSpan.html("");
            showMarker(finalSearchResult, () => { searchResultsSpan.html("The results of your search have been displayed on the map."); });
          } else {
            searchResultsSpan.html(
              getSelect(
                "Choose a dataset: ",
                [...Object.keys(searchResults)].sort(),
                (selection) => {
                  const finalSearchResult = searchResults[selection];
                  searchResultsSpan.html("");
                  showMarker(finalSearchResult, () => { searchResultsSpan.html("The results of your search have been displayed on the map."); });
                },
                true,
                "Confirm",
              )
            );
          }
        }
      });

    console.log("Ending inline script");
    
  </script>

  <script>
    $("#loadingIcon").hide();
    $("#pageContent").show(0, () => map.invalidateSize());
  </script>

</body>

</html>

<!-- references:
  https://github.com/Leaflet/Leaflet/tree/main/docs/examples (BSD 2-Clause license)
-->
