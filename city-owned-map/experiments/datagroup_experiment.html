<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="author" content="Claire Wagner (Summer 2022 Wheaton College Research Team)">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Map of Properties of Interest to HEI</title>

  <!-- Leaflet CDN -->
  <!--link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css"
    integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ=="
    crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"
    integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ=="
    crossorigin=""></script-->

  <!-- Leaflet.markercluster CDN -->
  <!--link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css"
    integrity="sha512-RLEjtaFGdC4iQMJDbMzim/dOvAu+8Qp9sw7QE4wIMYcg2goVoivzwgSZq9CsIxp4xKAZPKh5J2f2lOko2Ze6FQ=="
    crossorigin=""/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css"
    integrity="sha512-BBToHPBStgMiw0lD4AtkRIZmdndhB6aQbXpX7omcrXeG2PauGBl2lzq2xUZTxaLxYz5IDHlmneCZ1IJ+P3kYtQ=="
    crossorigin=""/>
  <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"
    integrity="sha512-MQlyPV+ol2lp4KodaU/Xmrn+txc1TP15pOBF/2Sfre7MRsA/pB4Vy58bEqe9u7a7DczMLtU5wT8n7OblJepKbg=="
    crossorigin=""></script-->

  <!-- Leaflet.FeatureGroup.SubGroup CDN -->
  <!--script src="https://unpkg.com/leaflet.featuregroup.subgroup@1.0.2/dist/leaflet.featuregroup.subgroup.js"
    integrity="sha512-gUiI5CXREIHHGko8AdlPYADT5MHvcCuqee1pjKR4qVcw69zVI+WvrnJcCxwU8JajpJoBjpvPIAGfDVFoQJhDfw=="
    crossorigin=""></script-->

  <!-- Local copies of Leaflet plugin scripts and stylesheets -->
  <link rel="stylesheet" href="../libraries/leaflet/leaflet.css"/>
  <script src="../libraries/leaflet/leaflet-src.js"></script>
  <link rel="stylesheet" href="../libraries/leaflet/plugins/MarkerCluster/MarkerCluster.css"/>
  <link rel="stylesheet" href="../libraries/leaflet/plugins/MarkerCluster/MarkerCluster.Default.css"/>
  <script src="../libraries/leaflet/plugins/MarkerCluster/leaflet.markercluster-src.js"></script>
  <script src="../libraries/leaflet/plugins/FeatureGroupSubGroup/leaflet.featuregroup.subgroup-src.js"></script>
  <link rel="stylesheet" href="../libraries/leaflet/plugins/ControlLayersTree/L.Control.Layers.Tree.css"/>
  <script src="../libraries/leaflet/plugins/ControlLayersTree/L.Control.Layers.Tree.js"></script>

  <!-- External files for stylesheets, functions, and data -->
  <link rel="stylesheet" href="../code/city-owned-map.css"/>
  <script src="../data/city-owned/city_owned_data.js"></script>
  <script src="../data/tax-sale/tax_sale_ward20_tax_year_2019.js"></script>
  <script src="../data/scavenger-sale/scavenger_data.js"></script>
  <script src="../data/geojson/ward_boundaries_sp34-6z76.js"></script>
    
</head>

<body>

  <div id="pageHeader">
    <h1>Map of City-Owned Properties</h1>
  </div>

  <p id="mapDescription"></p-->

  <!--div id="sgmRadiusForm" class="formDiv">
    <label>
      Set radius of circle around Sunshine Gospel Ministries (in kilometers):
      <input type="number" id="sgmRadiusInput" class="validInput"/>
    </label>
    <button type="button" id="sgmRadiusSetButton">
      Set Radius
    </button>
    <span id="sgmRadiusMessage" class="message"></span>
  </div-->

  <div id="map"></div>

  <script>

    // create map
    const map = L.map("map", {
      center: [41.783, -87.621],
      zoom: 13,
      scrollWheelZoom: false,
      doubleClickZoom: false,
    });

    // add tiles to map - reference: https://leafletjs.com/examples/layers-control/
    const osmtiles = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "&copy; <a href='http://www.openstreetmap.org/copyright'>OpenStreetMap</a>"
    }).addTo(map);

    // marker cluster group that serves as the parent for all clusterable markers
    const parentMarkerCluster = L.markerClusterGroup({
      maxClusterRadius: 50,
    }).addTo(map);

    const savedPins = new Set();

    function Datagroup(name, dataset, classify, getPopupContent) {
      this.name = name;
      this.dataset = dataset;
      this.childLayers = new Map();
      this.classify = classify;
      this.getPopupContent = getPopupContent;
    }

    function LayerInfo(datagroup, color, trackMarkerCount, parentMarkerClusterGroup) {
      this.datagroup = datagroup;
      this.color = color;
      if (trackMarkerCount) {
        this.markerCount = 0;
      }
      this.layer = parentMarkerClusterGroup
        ? L.featureGroup.subGroup(parentMarkerClusterGroup)
        : L.layerGroup();
    }

    // source: Sasha Trubetskoy, https://sashamaps.net/docs/resources/20-colors/
    const colors = [
      "#e6194B", "#3cb44b", "#ffe119", "#4363d8", "#f58231",
      "#911eb4", "#42d4f4", "#f032e6", "#bfef45", "#fabed4",
      "#469990", "#dcbeff", "#9A6324", "#fffac8", "#800000",
      "#aaffc3", "#808000", "#ffd8b1", "#000075", "#a9a9a9",
    ];
    let nextColor = 0;

    const datagroups = [
      new Datagroup(
        "City-Owned PINs",
        city_owned_data,
        (data) => { return ("ward" in data) && (data.ward === 20) ? "Ward 20" : "Other Wards" },
        (pinData) => {return getMarkerPopupContent(pinData, [
          ["PIN", pinData.pin],
          ["Address", pinData.property_address],
          ["Ward", pinData.ward],
          ["Property Status", pinData.property_status],
          ["Record Last Updated", pinData.last_update],
          ["Property Details", getPropertyDetailsLink(pinData.pin)],
        ])},
      ),
      new Datagroup(
        "Tax Sale (Ward 20, Tax Year 2019)",
        taxsale_ward20_data,
        (data) => { return "classification" in data ? data.classification : "Unclassified" },
        (pinData) => {return getMarkerPopupContent(pinData, [
          ["PIN", pinData.pin],
          ["Address", pinData.property_address],
          ["Ward", pinData.ward],
          ["2019 Tax Due (Including Interest)", `$${pinData.total_due_including_interest}`],
          ["2019 Tax Due (Excluding Interest)", `$${pinData.total_tax_due}`],
          ["Property Details", getPropertyDetailsLink(pinData.pin)],
        ])},
      ),
      new Datagroup(
        "Scavenger Sale 2022",
        scavenger_sale_data,
        (data) => { return "property_code_class" in data ? data.property_code_class : "Unclassified" },
        (pinData) => {return getMarkerPopupContent(pinData, [
          ["PIN", pinData.pin],
          ["Address", pinData.property_address],
          ["Ward", pinData.ward],
          ["Classification", pinData.property_code_meaning],
          ["Delinquent Tax", `$${pinData.delinquent_tax}`],
          ["Delinquent Interest", `$${pinData.delinquent_interest}`],
          ["Property Details", getPropertyDetailsLink(pinData.pin)],
        ])},
      ),
    ];

    function addDatagroupToMap(datagroup, trackMarkerCount, parentMarkerClusterGroup) {
      const dataset = datagroup.dataset;
      const childLayers = datagroup.childLayers;
      for (const key of Object.keys(dataset)) {
        const data = dataset[key];
        const layerInfoKey = datagroup.classify(data);
        // if this LayerInfo object doesn't yet exist, create it
        if (!(childLayers.has(layerInfoKey))) {
          childLayers.set(
            layerInfoKey,
            new LayerInfo(datagroup, colors[nextColor++ % colors.length], trackMarkerCount, parentMarkerClusterGroup)
          );
        }
        addMarkerToLayer(data, childLayers.get(layerInfoKey));
      }
    }

    function getDefaultSVG(width, height, color) {
      // based on an icon created by Naomi Wagner based on https://www.onlinewebfonts.com/icon/467018 (CC BY license)
      return (
        `<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
          x="0px" y="0px" width="${width}" height="${height}" viewBox="0 0 1920 1080"
          style="enable-background:new 0 0 1920 1080;" xml:space="preserve"
        >
          <style type="text/css">
            .svgIconStyle{stroke:#000000;stroke-width:30;stroke-miterlimit:10;}
          </style>
          <g>
            <path class="svgIconStyle" fill="${color}"" d="M939,50.7c9.8-0.7,19.6-1.2,29.7-0.9c17.9,0.5,35.8,1.8,53.4,5.2c104.3,20.6,185.6,75.2,242.1,165.4
              c32.8,52.4,49.8,110,51.9,171.9c1.2,36.3-5.6,71.1-17.6,105.2c-19.1,54.4-44.9,105.6-73.3,155.5c-53,93.3-114.1,181.1-178.6,266.6
              c-3.7,4.9-7.4,9.8-11.1,14.6c-12.4,16.2-24.8,32.3-37.4,48.3c-6.3,8-12.6,16-19,24c-3.2,4-6.3,8-9.5,12c-3.1,3.8-6,8.4-9.5,11.8
              c-1.4-0.8-2.8-2.6-3.8-3.8c-36.7-46.6-73.3-93.2-108.2-141.1c-54-74.1-105.6-149.9-151.5-229.4c-26.5-45.9-50.7-92.8-69.2-142.6
              c-10.7-28.9-19.2-58.5-22.3-89.3c-3.4-34.2-0.2-67.9,8.6-101C646.8,199.2,723,114.2,843.5,69.5c24.5-9.1,50-14.9,76.2-17.1
              C926.2,51.8,932.6,51.2,939,50.7z"
            />
            <path class="svgIconStyle" fill="#262626" fill-opacity="0.9" d="M810.6,407.3c-3,65.9,53.7,149,150.2,148.9c76.8-0.1,149.4-61.6,149.7-149.2c0.3-86.1-70.6-150.5-150.7-150.8
              C881.2,255.7,808.2,323.6,810.6,407.3z"
            />
          </g>
        </svg>`
      );
    }

    function getFavoritedSVG(width, height, color) {
      // based on an icon created by Naomi Wagner based on https://www.onlinewebfonts.com/icon/467018 (CC BY license)
      return (
        `<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
          x="0px" y="0px" width="${width}" height="${height}" viewBox="0 0 1920 1080"
          style="enable-background:new 0 0 1920 1080;" xml:space="preserve"
        >
          <style type="text/css">
            .svgIconStyle{stroke:#000000;stroke-width:50;stroke-miterlimit:10;}
          </style>
          <g>
            <path class="svgIconStyle" fill=${color} d="M938.9,50.4c28.4-1.7,56.9-0.1,83.2,5c104.3,20.6,185.6,75.2,242.1,165.4c32.8,52.4,49.8,110,51.9,171.9
              c1.2,36.3-5.6,71.1-17.6,105.2c-19.1,54.4-44.9,105.6-73.3,155.5c-53,93.3-114.1,181.1-178.6,266.6c-6.3,8.3-12.6,16.6-19,24.9
              c-11.8,15.3-23.6,30.6-35.6,45.7c-6,7.6-12,15.1-18,22.7c-3,3.8-6,7.5-9,11.3c-0.8,1-1.6,2-2.4,2.9c-0.6,0.7-1.3,2.2-2.1,2.6
              c-1.3,0.7-3.3-2.2-4.2-3.3c-36.7-46.6-73.3-93.2-108.2-141.1c-54-73.9-105.6-149.7-151.6-229.3c-26.5-45.9-50.7-92.8-69.2-142.6
              c-10.7-28.9-19.2-58.5-22.3-89.3c-3.4-34.2-0.2-67.9,8.6-101c33.1-123.9,109.3-208.9,229.8-253.6C872.7,59,905.8,52.4,938.9,50.4z"
            />
            <path class="svgIconStyle" fill="#262626" fill-opacity="0.9" d="M723.2,408.3c-4.8,104.3,85,235.9,237.8,235.7c121.5-0.2,236.6-97.5,237-236.2
              c0.4-136.3-111.7-238.2-238.6-238.8C834.9,168.4,719.2,275.9,723.2,408.3z"
            />
            <path class="svgIconStyle" fill="gold" d="M959,192.6c0.1-0.1,0.1-0.2,0.2-0.3c1.7,1.8,3.1,4.7,4.3,7c19,37.7,38.1,75.3,56.7,113.2c3,6.1,7.1,8,13,8.9
              c41.9,6.6,83.9,13.1,126.4,18.8c-0.9,4.6-4.4,7.4-7.2,10.5c-17.2,19.6-35.8,37.9-54.1,56.4c-10.2,10.3-20.2,20.7-30.7,30.7
              c-3.6,3.4-4.6,6.6-3.7,11.5c6.9,39.7,13.6,79.4,20.3,119c0.6,3.6,1.1,7.3,1.8,11.8c-6-0.8-10.6-3.6-15.2-6
              c-35.2-18.5-70.5-37-105.6-55.8c-3.7-2-6.4-2-10.2,0c-36.7,19.5-73.6,38.7-110.4,58c-2.9,1.5-5.9,2.8-10.1,4.7
              c1.7-11.4,3.1-21.7,4.8-31.9c5.6-33.7,11.2-67.3,17.1-100.9c0.8-4.3-0.4-6.8-3.2-9.7c-25.7-25.7-51.8-51-76.6-77.7
              c-5.9-6.3-12-12.5-17.1-20.3c27.1-3.8,53.3-7.4,79.4-11.2c15.4-2.2,30.7-4.9,46.1-7c6.5-0.9,10.8-4.2,14.1-9.4
              c5.9-9.2,11-18.9,15.8-28.8c13.7-28.3,27.3-56.8,41-85.1C956.9,197,957.9,194.8,959,192.6z"
            />
          </g>
        </svg>`
      );
    }

    function generateConditionalIcon(color, pin) {
      const divisor = 25;
      const width = 1920 / divisor;
      const height = 1080 / divisor;
      return L.divIcon({
        className: "custom_divicon",
        iconSize: [width, height],
        iconAnchor: [width/2, height],
        popupAnchor: [0,-(height/5)*4],
        html: savedPins.has(pin) ? getFavoritedSVG(width, height, color) : getDefaultSVG(width, height, color),
      });
    }

    function updateMarkerIcon(pin, marker, color) {
      marker.setIcon(generateConditionalIcon(color, pin));
    }

    function addSavedPin(pinData) {
      savedPins.add(pinData.pin);
      updateMarkerIcon(pinData.pin, pinData.marker, pinData.layerInfo.color);
    }

    function removeSavedPin(pinData) {
      savedPins.delete(pinData.pin);
      updateMarkerIcon(pinData.pin, pinData.marker, pinData.layerInfo.color);
    }

    function getMarkerPopupContent(pinData, dataToDisplay) {
      const popupDiv = document.createElement("div");
      // category
      const categoryDiv = document.createElement("div");
      categoryDiv.setAttribute("class", "center underlined");
      categoryDiv.innerText = pinData.layerInfo.datagroup.name;
      popupDiv.appendChild(categoryDiv);
      // data
      const dataDisplay = document.createElement("p");
      dataDisplay.setAttribute("class", "increasedLineHeight");
      let dataList = [];
      for (const [label, data] of dataToDisplay) {
        dataList.push(`<b>${label}</b>: ${data}`);
      }
      dataDisplay.innerHTML = dataList.join("<br>");
      popupDiv.appendChild(dataDisplay);
      // save pin button
      const savedPinButton = document.createElement("button");
      savedPinButton.setAttribute("type", "button");
      function updateSavedPinButtonText() {
        savedPinButton.innerText = savedPins.has(pinData.pin) ? "Remove from Saved PINs" : "Add to Saved PINs";
      }
      updateSavedPinButtonText();
      savedPinButton.addEventListener("click", () => {
        if (savedPins.has(pinData.pin)) {
          removeSavedPin(pinData);
        } else {
          addSavedPin(pinData);
        }
        updateSavedPinButtonText();
      });
      const savedPinButtonDiv = document.createElement("div");
      savedPinButtonDiv.setAttribute("class", "center");
      savedPinButtonDiv.appendChild(savedPinButton);
      popupDiv.appendChild(savedPinButtonDiv);
      return popupDiv;
    }

    function getPropertyDetailsLink(pin) {
      return `<a href="https://www.cookcountyassessor.com/pin/${pin}" target="_blank" rel="noopener">Assessor's Office</a>`;
    }

    function generateIcon(color) {
      const width = 40;
      const height = 40;
      return L.divIcon({
        className: "custom_divicon",
        iconSize: [width, height],
        iconAnchor: [width/2, height],
        popupAnchor: [0,-(height/5)*4],
        html:
          `<svg
            width="${width}"
            height="${height}"
            viewBox="0 0 640 1024"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M320 0c-177 0-320 143-320 320s160 416 320 704c160-288 320-527 320-704s-143-320-320-320z m0 448c-71 0-128-57-128-128s57-128 128-128 128 57 128 128-57 128-128 128z"
              fill=${color}
              stroke=black
              stroke-width=20px
            />
          </svg>`
      });
    };

    function addMarkerToLayer(markerData, layerInfo) {
      const marker = L.marker(
        [markerData.latitude, markerData.longitude],
        {
          icon: generateConditionalIcon(layerInfo.color, markerData.pin),
        }
      );
      layerInfo.layer.addLayer(marker);
      if (layerInfo.markerCount != null) {
        layerInfo.markerCount++;
      }
      markerData.marker = marker;
      markerData.layerInfo = layerInfo;
      marker.bindPopup(layerInfo.datagroup.getPopupContent(markerData));
    }

    // function to be run for each ward feature
    const onEachWard = (feature, layer) => {
      if (feature.properties && feature.properties.ward) {
        layer.bindPopup("Ward " + feature.properties.ward);
      }
    };

    // add ward boundaries
    let ward20Feature = null;
    const wardBoundaries = {
      name: "Ward Boundaries",
      color: "black",
      layer: L.geoJSON(
        ward_boundaries_geojson,
        {
          style: {
            color: "black",
            weight: 2,
            fillOpacity: 0,
          },
          onEachFeature: (feature, layer) => {
            onEachWard(feature, layer);
            // Add shaded layer for Ward 20
            if (feature.properties && feature.properties.ward === "20") {
              ward20Feature = feature;
            }
          }
        }
      ),
    };

    // Add Ward 20 fill
    const ward20FillColor = "#e9ac3c";
    const ward20Fill = {
      name: "Ward 20 (shaded)",
      color: ward20FillColor,
      layer: L.geoJSON(
        ward20Feature,
        {
          style: {
            color: "black",
            weight: 2,
            fillColor: ward20FillColor,
            fillOpacity: 0.4,
          },
          onEachFeature: onEachWard,
        }
      ),
    };

    // add layer control
    const baseTree = {
      label: "Base Layers",
      children: [
        { label: "Open StreetMap", layer: osmtiles },
      ]
    };

    function getParentOverlayLabel(name) {
      return (
        `<span class='parentLayer'>${name}</span>`
      );
    }

    function getLeafOverlayLabel(layerInfo) {
      let label = `<span style='color: ${layerInfo.color}'>&#9724;</span><span class='leafLayer'> ${layerInfo.name}`;
      if (layerInfo.markerCount != null && layerInfo.markerCount > 0) {
        label += ` (${layerInfo.markerCount}  marker${layerInfo.markerCount > 1 ? "s" : ""})`;
      }
      label += "</span>";
      return label;
    }

    function getLeafOverlayLabelNew(layerInfo, name) {
      let label = `<span style='color: ${layerInfo.color}'>&#9724;</span><span class='leafLayer'> ${name}`;
      if (layerInfo.markerCount != null && layerInfo.markerCount > 0) {
        label += ` (${layerInfo.markerCount}  marker${layerInfo.markerCount > 1 ? "s" : ""})`;
      }
      label += "</span>";
      return label;
    }

    function getOverlay(layerInfo, addToMap) {
      if (addToMap) {
        layerInfo.layer.addTo(map);
      }
      return { label: getLeafOverlayLabel(layerInfo), layer: layerInfo.layer };
    }
    
    function getOverlayNew(layerInfo, name, addToMap) {
      if (addToMap) {
        layerInfo.layer.addTo(map);
      }
      return { label: getLeafOverlayLabelNew(layerInfo, name), layer: layerInfo.layer };
    }

    function getDatagroupOverlaySubtree(datagroup, selectAllCheckbox, collapsed, sortFunction) {
      const children = [];
      const childLayers = datagroup.childLayers;
      for (const key of [...childLayers.keys()].sort(sortFunction)) {
        children.push(getOverlayNew(childLayers.get(key), key, false));
      }
      return {
        label: getParentOverlayLabel(datagroup.name),
        selectAllCheckbox: selectAllCheckbox,
        collapsed: collapsed,
        children: children,
      };
    }

    addDatagroupToMap(datagroups[0], true, parentMarkerCluster);
    addDatagroupToMap(datagroups[1], true, parentMarkerCluster);
    addDatagroupToMap(datagroups[2], true, parentMarkerCluster);

    const overlayTree = {
      label: getParentOverlayLabel("Map Layers"),
      children: [
        {
          label: getParentOverlayLabel("Ward Geography"),
          selectAllCheckbox: true,
          collapsed: true,
          children: [
            getOverlay(wardBoundaries, true),
            getOverlay(ward20Fill, true),
          ]
        },
        getDatagroupOverlaySubtree(datagroups[0], true, false, (a, b) => { return a === "Ward 20" ? -1 : b === "Ward 20" ? 1 : a < b ? -1 : a > b ? 1 : 0 } ),
        //getDatagroupOverlaySubtree(datagroups[1], true, false),
        //getDatagroupOverlaySubtree(datagroups[2], true, false),
      ]
    };

    const layerControlTree = L.control.layers.tree(
      baseTree,
      overlayTree,
      {
        collapsed : false,
        hideSingleBase: true,
      }
    ).addTo(map);

    // add map description
    document.getElementById("mapDescription").innerHTML = "This is a map of properties that may be "
      + "of interest to Sunshine Gospel Ministries' Housing Equity Initiative. Click on each marker "
      + "to view more information about the property it represents.";

    function displayMessage(destination, message, color) {
      destination.style.color = color;
      destination.innerText = message;
    }

  console.log("Inline script has finished executing.");
    
  </script>   

</body>

</html>

<!-- references:
  https://github.com/Leaflet/Leaflet/tree/main/docs/examples (BSD 2-Clause license)
  https://github.com/Leaflet/Leaflet.markercluster (MIT license)
  https://github.com/ghybs/Leaflet.FeatureGroup.SubGroup (BSD 2-Clause license)
-->
