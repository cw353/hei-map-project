<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="author" content="Claire Wagner (Summer 2022 Wheaton College Research Team)">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>City-Owned Properties in Ward 20</title>

  <!-- Leaflet CDN -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css"
    integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ=="
    crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"
    integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ=="
    crossorigin=""></script>

  <!-- Leaflet.markercluster CDN -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css"
    integrity="sha512-RLEjtaFGdC4iQMJDbMzim/dOvAu+8Qp9sw7QE4wIMYcg2goVoivzwgSZq9CsIxp4xKAZPKh5J2f2lOko2Ze6FQ=="
    crossorigin=""/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css"
    integrity="sha512-BBToHPBStgMiw0lD4AtkRIZmdndhB6aQbXpX7omcrXeG2PauGBl2lzq2xUZTxaLxYz5IDHlmneCZ1IJ+P3kYtQ=="
    crossorigin=""/>
  <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"
    integrity="sha512-MQlyPV+ol2lp4KodaU/Xmrn+txc1TP15pOBF/2Sfre7MRsA/pB4Vy58bEqe9u7a7DczMLtU5wT8n7OblJepKbg=="
    crossorigin=""></script>

  <!-- Leaflet.FeatureGroup.SubGroup CDN -->
  <script src="https://unpkg.com/leaflet.featuregroup.subgroup@1.0.2/dist/leaflet.featuregroup.subgroup.js"
    integrity="sha512-gUiI5CXREIHHGko8AdlPYADT5MHvcCuqee1pjKR4qVcw69zVI+WvrnJcCxwU8JajpJoBjpvPIAGfDVFoQJhDfw=="
    crossorigin=""></script>

  <!-- Local copies of Leaflet plugin scripts and stylesheets -->
  <link rel="stylesheet" href="libraries/leaflet/plugins/ControlLayersTree/L.Control.Layers.Tree.css"/>
  <script src="libraries/leaflet/plugins/ControlLayersTree/L.Control.Layers.Tree.js"></script>

  <!-- External files for stylesheets, functions, and data -->
  <link rel="stylesheet" href="code/map_stylesheet.css"/>
  <script src="data/city-owned/city_owned_data.js"></script>
  <script src="data/tax-sale/tax_sale_ward20_tax_year_2019.js"></script>
  <script src="data/geojson/ward_boundaries.js"></script>
    
</head>

<body>

  <div id="pageHeader"></div>

  <p id="mapDescription"></p-->

  <div id="ward20OfficeRadiusForm" class="formDiv">
    <label>
      Set radius of circle around Ward 20 Alderwoman's Office (in kilometers):
      <input type="number" id="ward20OfficeRadiusInput" class="radiusInput validInput"/>
    </label>
    <button type="button" id="ward20OfficeRadiusSetButton">
      Set Radius
    </button>
    <span id="ward20OfficeRadiusMessage" class="message"></span>
  </div>

  <div id="sgmRadiusForm" class="formDiv">
    <label>
      Set radius of circle around Sunshine Gospel Ministries (in kilometers):
      <input type="number" id="sgmRadiusInput" class="radiusInput validInput"/>
    </label>
    <button type="button" id="sgmRadiusSetButton">
      Set Radius
    </button>
    <span id="sgmRadiusMessage" class="message"></span>
  </div>

  <div id="map"></div>

  <script>

    document.getElementById("pageHeader").innerHTML = `<h1>${document.title}</h1>`;

    // create map
    const map = L.map("map", {
      center: [41.783, -87.621],
      zoom: 13.4,
      scrollWheelZoom: false,
      doubleClickZoom: false,
      zoomDelta: 0.1,
      zoomSnap: 0,
    });

    // add tiles to map - reference: https://leafletjs.com/examples/layers-control/
    const osmtiles = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "&copy; <a href='http://www.openstreetmap.org/copyright'>OpenStreetMap</a>"
    }).addTo(map);

    // marker cluster group that serves as the parent for all clusterable markers
    const parentMarkerCluster = L.markerClusterGroup({
      maxClusterRadius: 60,
    }).addTo(map);

    map.attributionControl.addAttribution("&copy; <a href='https://data.cityofchicago.org/'>Chicago Data Portal</a>");
    map.attributionControl.addAttribution("&copy; <a href='https://datacatalog.cookcountyil.gov/'>Cook County Open Data</a>");
    map.attributionControl.addAttribution("&copy; <a href='https://www.cookcountytreasurer.com/'>Cook County Treasurer</a>");

    const cityOwnedWard20 = {
      name: "Ward 20",
      color: "#0000ff",
      layer: L.featureGroup.subGroup(parentMarkerCluster),
      markerCount: 0,
    };

    const cityOwnedOtherWards = {
      name: "Other Wards",
      color: "#9900cc",
      layer: L.featureGroup.subGroup(parentMarkerCluster),
      markerCount: 0,
    };

    const taxSaleVacant = {
      name: "Vacant Land",
      color: "#ff6600",
      layer: L.featureGroup.subGroup(parentMarkerCluster),
      markerCount: 0,
    };

    const taxSaleResidential = {
      name: "Residential",
      color: "#669900",
      layer: L.featureGroup.subGroup(parentMarkerCluster),
      markerCount: 0,
    };

    const taxSaleCommercial = {
      name: "Commercial/Industrial",
      color: "#666699",
      layer: L.featureGroup.subGroup(parentMarkerCluster),
      markerCount: 0,
    };

    const sunshineGospelPin = {
      name: "Sunshine Gospel Ministries",
      color: "#ff66ff",
      layer: L.layerGroup(),
      markerCount: 0,
    };

    const sunshineGospelCircle = {
      name: "Circle around Sunshine Gospel Ministries",
      color: "#ff80ff",
      layer: L.layerGroup(),
    };

    const ward20OfficePin = {
      name: "Ward 20 Office",
      color: "#0099ff",
      layer: L.layerGroup(),
      markerCount: 0,
    };

    const ward20OfficeCircle = {
      name: "Circle around Ward 20 Office",
      color: "#00ace6",
      layer: L.layerGroup(),
    };

    function getCityOwnedMarkerPopupContent(pinData) {
      // display info about pin
      const dataDisplay = document.createElement("p");
      dataDisplay.setAttribute("class", "increasedLineHeight");
      dataDisplay.innerHTML = [
        `PIN: ${pinData.pin}`,
        `Address: ${pinData.property_address}`,
        `Zip Code: ${pinData.property_zip}`,
        `Ward: ${pinData.ward}`,
        `Property Status: ${pinData.property_status}`,
        `Record Last Updated: ${pinData['last_update']}`,
        `Property Details: <a href="https://www.cookcountyassessor.com/pin/${pinData.pin}" target="_blank" rel="noopener">Assessor's Office</a>`
      ].join("<br>");
      const popupDiv = document.createElement("div");
      popupDiv.appendChild(dataDisplay);
      return popupDiv;
    }

    function getTaxSaleMarkerPopupContent(pinData) {
      // display info about pin
      const dataDisplay = document.createElement("p");
      dataDisplay.setAttribute("class", "increasedLineHeight");
      dataDisplay.innerHTML = [
        `PIN: ${pinData.pin}`,
        `Address: ${pinData.property_address}`,
        `Zip Code: ${pinData.property_zip}`,
        `Ward: ${pinData.ward}`,
        `Classification: ${pinData.classification}`,
        `2019 Tax Due (Including Interest): $${pinData.total_due_including_interest}`,
        `2019 Tax Due (Excluding Interest): $${pinData.total_tax_due}`,
        `Property Details: <a href="https://www.cookcountyassessor.com/pin/${pinData.pin}" target="_blank" rel="noopener">Assessor's Office</a>`
      ].join("<br>");
      const popupDiv = document.createElement("div");
      popupDiv.appendChild(dataDisplay);
      return popupDiv;
    }

    function generateIcon(color) {
      // based on an icon created by Naomi Wagner based on https://www.onlinewebfonts.com/icon/467018 (CC BY license)
      const divisor = 25;
      const width = 1920 / divisor;
      const height = 1080 / divisor;
      return L.divIcon({
        className: "custom_divicon",
        iconSize: [width, height],
        iconAnchor: [width/2, height],
        popupAnchor: [0,-(height/5)*4],
        html:
          `<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
            x="0px" y="0px" viewBox="0 0 1920 1080" style="enable-background:new 0 0 1920 1080;"
            xml:space="preserve"
          >
            <style type="text/css">
              .svgIconStyle{stroke:#000000;stroke-width:30;stroke-miterlimit:10;}
            </style>
            <g>
              <path class="svgIconStyle" fill="${color}"" d="M939,50.7c9.8-0.7,19.6-1.2,29.7-0.9c17.9,0.5,35.8,1.8,53.4,5.2c104.3,20.6,185.6,75.2,242.1,165.4
                c32.8,52.4,49.8,110,51.9,171.9c1.2,36.3-5.6,71.1-17.6,105.2c-19.1,54.4-44.9,105.6-73.3,155.5c-53,93.3-114.1,181.1-178.6,266.6
                c-3.7,4.9-7.4,9.8-11.1,14.6c-12.4,16.2-24.8,32.3-37.4,48.3c-6.3,8-12.6,16-19,24c-3.2,4-6.3,8-9.5,12c-3.1,3.8-6,8.4-9.5,11.8
                c-1.4-0.8-2.8-2.6-3.8-3.8c-36.7-46.6-73.3-93.2-108.2-141.1c-54-74.1-105.6-149.9-151.5-229.4c-26.5-45.9-50.7-92.8-69.2-142.6
                c-10.7-28.9-19.2-58.5-22.3-89.3c-3.4-34.2-0.2-67.9,8.6-101C646.8,199.2,723,114.2,843.5,69.5c24.5-9.1,50-14.9,76.2-17.1
                C926.2,51.8,932.6,51.2,939,50.7z"/>
              <path class="svgIconStyle" fill="#f4f4f4" fill-opacity="0.9" d="M810.6,407.3c-3,65.9,53.7,149,150.2,148.9c76.8-0.1,149.4-61.6,149.7-149.2c0.3-86.1-70.6-150.5-150.7-150.8
                C881.2,255.7,808.2,323.6,810.6,407.3z"/>
            </g>
          </svg>`
      });
    };

    function addMarker(markerData, layerInfo, popupContent) {
      layerInfo.layer.addLayer(L.marker(
        [markerData.latitude, markerData.longitude],
        {
          icon: generateIcon(layerInfo.color),
        }
      ).bindPopup(popupContent));
      if (layerInfo.markerCount != null) {
        layerInfo.markerCount++;
      }
    }

    for (const pin of Object.keys(city_owned_data)) {
      const pinData = city_owned_data[pin];
      addMarker(
        pinData,
        (pinData.ward === 20) ? cityOwnedWard20 : cityOwnedOtherWards,
        getCityOwnedMarkerPopupContent(pinData),
      );
    }

    for (const pin of Object.keys(taxsale_ward20_data)) {
      const pinData = taxsale_ward20_data[pin];
      const layerInfo = (pinData.classification === "Vacant Land")
        ? taxSaleVacant
        : (pinData.classification === "Residential")
          ? taxSaleResidential
          : (pinData.classification === "Commercial/Industrial")
            ? taxSaleCommercial
            : null;
      if (layerInfo !== null) {
        addMarker(
          pinData,
          layerInfo,
          getTaxSaleMarkerPopupContent(pinData),
        );
      } else {
        console.log(`tax sale pin ${pin} could not be classified (classification is ${pinData.classification})`);
      }
    }

    addMarker(
      sunshine_gospel,
      sunshineGospelPin,
      "<a href='https://www.sunshinegospel.org/' target='_blank' rel='noopener'>Sunshine Gospel Ministries</a>"
    );

    const sgmCircle = L.circle([sunshine_gospel.latitude, sunshine_gospel.longitude], {
      radius: 3000,
      color: sunshineGospelCircle.color,
      fillOpacity: 0.15,
    }).addTo(sunshineGospelCircle.layer);

    // source: https://data.cityofchicago.org/Facilities-Geographic-Boundaries/Ward-Offices/htai-wnw4
    const ward20OfficeCoords = { latitude: 41.7905, longitude : -87.630388 };

    addMarker(
      ward20OfficeCoords,
      ward20OfficePin,
      "Ward 20 Office",
    );

    const ward20OfficeCircleMarker = L.circle([ward20OfficeCoords.latitude, ward20OfficeCoords.longitude], {
      radius: 3000,
      color: ward20OfficeCircle.color,
      fillOpacity: 0.15,
    }).addTo(ward20OfficeCircle.layer);

    // function to be run for each ward feature
    const onEachWard = (feature, layer) => {
      if (feature.properties && feature.properties.ward) {
        layer.bindPopup("Ward " + feature.properties.ward);
      }
    };

    // add ward boundaries
    let ward20Feature = null;
    const wardBoundaryOutlines = {
      name: "Ward Boundaries",
      color: "black",
      layer: L.geoJSON(
        ward_boundaries_2015_to_2023.data,
        {
          style: {
            color: "black",
            weight: 2,
            fillOpacity: 0,
          },
          onEachFeature: (feature, layer) => {
            onEachWard(feature, layer);
            // Add shaded layer for Ward 20
            if (feature.properties && feature.properties.ward === "20") {
              ward20Feature = feature;
            }
          }
        }
      ).addTo(map),
    };

    // Add Ward 20 fill
    const ward20FillColor = "#e9ac3c";
    const ward20Fill = {
      name: "Ward 20 (shaded)",
      color: ward20FillColor,
      layer: L.geoJSON(
        ward20Feature,
        {
          style: {
            color: "black",
            weight: 2,
            fillColor: ward20FillColor,
            fillOpacity: 0.4,
          },
          onEachFeature: onEachWard,
        }
      ).addTo(map),
    };

    // add layer control

    const baseTree = {
      label: "Base Layers",
      children: [
        { label: "Open StreetMap", layer: osmtiles },
      ]
    };

    function getParentOverlayLabel(name) {
      return (
        `<span class='parentLayer'>${name}</span>`
      );
    }

    function getLeafOverlayLabel(layerInfo) {
      let label = `<span style='color: ${layerInfo.color}'>&#9724;</span><span class='leafLayer'> ${layerInfo.name}`;
      if (layerInfo.markerCount != null && layerInfo.markerCount > 0) {
        label += ` (${layerInfo.markerCount}  marker${layerInfo.markerCount > 1 ? "s" : ""})`;
      }
      label += "</span>";
      return label;
    }

    function getOverlay(layerInfo, addToMap) {
      if (addToMap) {
        layerInfo.layer.addTo(map);
      }
      return { label: getLeafOverlayLabel(layerInfo), layer: layerInfo.layer };
    }

    const overlayTree = {
      label: getParentOverlayLabel("Map Layers"),
      children: [
        {
          label: getParentOverlayLabel("Ward Geography"),
          selectAllCheckbox: true,
          collapsed: false,
          children: [
            getOverlay(wardBoundaryOutlines, true),
            getOverlay(ward20Fill, true),
          ]
        },
        {
          label: getParentOverlayLabel("Ward 20 Alderwoman's Office"),
          selectAllCheckbox: true,
          collapsed: false,
          children: [
            getOverlay(ward20OfficePin, true),
            getOverlay(ward20OfficeCircle, true),
          ]
        },
        {
          label: getParentOverlayLabel("Sunshine Gospel Ministries"),
          selectAllCheckbox: true,
          collapsed: false,
          children: [
            getOverlay(sunshineGospelPin, true),
            getOverlay(sunshineGospelCircle, false),
          ]
        },
        {
          label: getParentOverlayLabel("City-Owned PINs (Possibly for Sale)"),
          selectAllCheckbox: true,
          collapsed: false,
          children: [
            getOverlay(cityOwnedWard20, true),
            getOverlay(cityOwnedOtherWards, false),
          ]
        },
        {
          label: getParentOverlayLabel("Tax Sale (Ward 20, Tax Year 2019)"),
          selectAllCheckbox: true,
          collapsed: false,
          children: [
            getOverlay(taxSaleVacant, false),
            getOverlay(taxSaleResidential, false),
            getOverlay(taxSaleCommercial, false),
          ]
        },
      ]
    };

    const layerControlTree = L.control.layers.tree(
      baseTree,
      overlayTree,
      {
        collapsed : false,
        hideSingleBase: true,
      }
    ).addTo(map);

    // add map description
    document.getElementById("mapDescription").innerHTML = "This is a map of city-owned properties"
      + " that may be for sale in Ward 20, prepared for Alderwoman Jeanette Taylor by the Housing"
      + " Equity Initiative of Sunshine Gospel Ministries. Click on each marker to view more"
      + " information about the property it represents.";

    function displayMessage(destination, message, color) {
      destination.style.color = color;
      destination.innerText = message;
    }

    function setUpRadiusInput(circleMarker, inputElement, applyChangesButton, messageElement) {
      // allow the user to change the radius of circleMarker
      inputElement.value = circleMarker.getRadius() / 1000; // meters to kilometers
      applyChangesButton.addEventListener("click", (event) => {
        const newRadius = parseFloat(inputElement.value);
        if (!isNaN(newRadius)) {
          // valid float
          circleMarker.setRadius(newRadius * 1000); // kilometers to meters
          inputElement.classList.replace("invalidInput", "validInput");
          displayMessage(messageElement, `Success! The radius has been set to ${newRadius} km.`, "green");
        } else {
          // invalid float
          inputElement.classList.replace("validInput", "invalidInput");
          displayMessage(messageElement, "Error: input must be a valid number.", "red");
        }
      });
    }

    // allow the user to change the radius of circle around Ward 20 office
    setUpRadiusInput(
      ward20OfficeCircleMarker,
      document.getElementById("ward20OfficeRadiusInput"),
      document.getElementById("ward20OfficeRadiusSetButton"),
      document.getElementById("ward20OfficeRadiusMessage"),
    );

    // allow the user to change the radius of circle around Sunshine Gospel Ministries
    setUpRadiusInput(
      sgmCircle,
      document.getElementById("sgmRadiusInput"),
      document.getElementById("sgmRadiusSetButton"),
      document.getElementById("sgmRadiusMessage"),
    );

    // reference: https://leafletjs.com/examples/choropleth/
    const legend = L.control({position: "bottomleft"});

    legend.onAdd = (map) => {
      const div = L.DomUtil.create("div", "legend");
      div.innerHTML = "<header>Marker Clusters</header>"
      const rangeBounds = [1, 10, 100];
      const colors = ["rgba(110, 204, 57, 0.8)", "rgba(240, 194, 12, 0.6)", "rgba(241, 128, 23, 0.8)"];
      for (let i = 0; i < rangeBounds.length; i++) {
        div.innerHTML += `<p><i style="background-color: ${colors[i]}"></i> ${rangeBounds[i]}` + (rangeBounds[i+1] ? `&ndash;${rangeBounds[i+1]} properties<br>` : "+ properties</p>");
      }
      return div;
    }

    legend.addTo(map);

    console.log("Inline script has finished executing.");
    
  </script>   

</body>

</html>

<!-- references:
  https://github.com/Leaflet/Leaflet/tree/main/docs/examples (BSD 2-Clause license)
  https://github.com/Leaflet/Leaflet.markercluster (MIT license)
  https://github.com/ghybs/Leaflet.FeatureGroup.SubGroup (BSD 2-Clause license)
-->
