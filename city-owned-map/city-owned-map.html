<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="author" content="Claire Wagner (Summer 2022 Wheaton College Research Team)">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Map of City-Owned Properties</title>

  <!-- Leaflet CDN -->
  <!--link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css"
    integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ=="
    crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"
    integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ=="
    crossorigin=""></script-->

  <!-- Leaflet.markercluster CDN -->
  <!--link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css"
    integrity="sha512-RLEjtaFGdC4iQMJDbMzim/dOvAu+8Qp9sw7QE4wIMYcg2goVoivzwgSZq9CsIxp4xKAZPKh5J2f2lOko2Ze6FQ=="
    crossorigin=""/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css"
    integrity="sha512-BBToHPBStgMiw0lD4AtkRIZmdndhB6aQbXpX7omcrXeG2PauGBl2lzq2xUZTxaLxYz5IDHlmneCZ1IJ+P3kYtQ=="
    crossorigin=""/>
  <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"
    integrity="sha512-MQlyPV+ol2lp4KodaU/Xmrn+txc1TP15pOBF/2Sfre7MRsA/pB4Vy58bEqe9u7a7DczMLtU5wT8n7OblJepKbg=="
    crossorigin=""></script-->

  <!-- Leaflet.FeatureGroup.SubGroup CDN -->
  <!--script src="https://unpkg.com/leaflet.featuregroup.subgroup@1.0.2/dist/leaflet.featuregroup.subgroup.js"
    integrity="sha512-gUiI5CXREIHHGko8AdlPYADT5MHvcCuqee1pjKR4qVcw69zVI+WvrnJcCxwU8JajpJoBjpvPIAGfDVFoQJhDfw=="
    crossorigin=""></script-->

  <!-- Local copies of scripts and stylesheets -->
  <link rel="stylesheet" href="leaflet/leaflet.css"/>
  <script src="leaflet/leaflet-src.js"></script>
  <link rel="stylesheet" href="leaflet/plugins/MarkerCluster/MarkerCluster.css"/>
  <link rel="stylesheet" href="leaflet/plugins/MarkerCluster/MarkerCluster.Default.css"/>
  <script src="leaflet/plugins/MarkerCluster/leaflet.markercluster-src.js"></script>
  <script src="leaflet/plugins/FeatureGroupSubGroup/leaflet.featuregroup.subgroup-src.js"></script>

  <!-- External files for stylesheets, functions, and data -->
  <link rel="stylesheet" href="code/city-owned-map.css"/>
  <script src="data/data.js"></script>
  <script src="data/ward_boundaries_sp34-6z76.js"></script>
  <script src="code/city_owned_map_functions.js"></script>
    
</head>

<body>

  <div id="pageHeader">
    <h1>Map of City-Owned Properties</h1>
  </div>

  <p id="mapDescription"></p-->

  <div id="savedPinsForm" class="formDiv">
    <button type="button" id="viewSavedPinsButton">View Saved PINs</button>
    <button type="button" id="clearSavedPinsButton">Clear Saved PINs</button>
    <button type="button" id="exportSavedPinsButton">Export Saved PINs</button>
    <span id="exportSavedPinsMessage" class="message"></span>
  </div>

  <div id="pinSearchForm" class="formDiv">
    <label>
      Search for city-owned PIN on map:
      <input type="text" id="pinSearchInput" class="validInput"/>
    </label>
    <button type="button" id="pinSearchButton">
      Search
    </button>
    <span id="pinSearchMessage" class="message"></span>
  </div>

  <div id="sgmRadiusForm" class="formDiv">
    <label>
      Set radius of circle around Sunshine Gospel Ministries (in kilometers):
      <input type="number" id="sgmRadiusInput" class="validInput"/>
    </label>
    <button type="button" id="sgmRadiusSetButton">
      Set Radius
    </button>
    <span id="sgmRadiusMessage" class="message"></span>
  </div>

  <div id="map"></div>

  <script>

    // create map
    const map = L.map("map", {
      center: [41.783, -87.621],
      zoom: 13,
      scrollWheelZoom: false,
      doubleClickZoom: false,
    });

    // add tiles to map - reference: https://leafletjs.com/examples/layers-control/
    const osmtiles = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "&copy; <a href='http://www.openstreetmap.org/copyright'>OpenStreetMap</a>"
    }).addTo(map);

    // set of pins saved by user
    const savedPins = new Set(
        localStorage.getItem("city-owned-map-saved-pins")
          ? JSON.parse(localStorage.getItem("city-owned-map-saved-pins"))
          : null
    );

    /* Create ward boundary layers */
    const geoJSONLayers = new Map();

    // function to be run for each ward feature
    const onEachWard = (feature, layer) => {
      if (feature.properties && feature.properties.ward) {
        layer.bindPopup("Ward " + feature.properties.ward);
      }
    };
    
    let ward20Feature = null;

    // Add ward boundaries layer
    if (wardBoundaries) {
      addGeoJSONLayer("wardBoundaries", "Ward Boundaries", "black", geoJSONLayers, L.geoJSON(
        wardBoundaries,
        {
          style: {
            color: "black",
            weight: 2,
            fillOpacity: 0,
          },
          onEachFeature: (feature, layer) => {
            onEachWard(feature, layer);
            // Add shaded layer for Ward 20
            if (feature.properties && feature.properties.ward === "20") {
              ward20Feature = feature;
            }
          }
        }
      ));
    }

    // Add Ward 20 fill
    if (ward20Feature) {
      const ward20FillColor = "#e9ac3c";
      addGeoJSONLayer("ward20Fill", "Ward 20 (shaded)", ward20FillColor, geoJSONLayers, L.geoJSON(
        ward20Feature,
        {
          style: {
            color: "black",
            weight: 2,
            fillColor: ward20FillColor,
            fillOpacity: 0.4,
          },
          onEachFeature: onEachWard,
        }
      ));
    }

    const parentMarkerCluster = L.markerClusterGroup({
      maxClusterRadius: 50,
    }).addTo(map);

    // city-owned marker layers
    const cityOwnedLayers = new Map();

    // Sunshine Gospel Ministries-related layers
    const sunshineGospelLayers = new Map();

    /**
     * Helper function to add pin to Saved Pins list.
     * @param pin The pin to add.
     * Postcondition: The pin has been added to the Saved Pins list, and the color of its marker
     * has been set accordingly.
     */
    function addSavedPin(pin) {
      savedPins.add(pin);
      data[pin].marker.setIcon(generateIconNewVer2(cityOwnedLayers.get(data[pin].layerName).color, pin));
    }

    /**
     * Helper function to remove a pin from the Saved Pins list.
     * @param pin The pin to add.
     * Postcondition: The pin has been removed from the Saved Pins list, and the color of its marker
     * has been reset to its original value.
     */
    function removeSavedPin(pin) {
      savedPins.delete(pin);
      data[pin].marker.setIcon(generateIconNewVer2(cityOwnedLayers.get(data[pin].layerName).color, pin));
    }

    /**
     * Helper function to clear all saved pins.
     * Postcondition: savedPins has been cleared and the colors and popup contents of all markers
     * corresponding to previously saved pins have been restored to their original values (but
     * the list of saved pins in local storage has not been updated).
     */
    function clearSavedPins() {
      const tmp = [...savedPins];
      savedPins.clear();
      for (const pin of tmp) {
        // restore marker popup content
        data[pin].marker.setPopupContent(getMarkerPopupContent(pin, data[pin]));
        // restore original marker color
        data[pin].marker.setIcon(generateIconNewVer2(cityOwnedLayers.get(data[pin].layerName).color, pin));
      }
    }

    /**
     * Helper function to export saved pins as JSON.
     * @param filename The name of the exported JSON.
     */
    function exportSavedPins(filename) {
      // which fields to include in the exported data
      const fieldsToExport = [
        "pin",
        "property_address",
        "property_zip",
        "ward",
        "sq_ft",
        "property_status",
        "managing_organization",
        "date_of_acquisition",
        "date_of_disposition",
        "last_update",
        "tract_geoid",
        "latitude",
        "longitude",
      ];
      // create JSON
      let counter = 0;
      let toExport = "[";
      savedPins.forEach((pin) => {
        toExport += JSON.stringify(data[pin], fieldsToExport);
        toExport += (counter++ < savedPins.size-1) ? "," : "";
      });
      toExport += "]";
      // download JSON
      downloadDataAsFile(toExport, `${exportFileName}`, "/application/json");
    }

    /**
     * Helper function to generate popup content for a marker based on the PIN it represents.
     * @param pin The pin.
     */
    function getMarkerPopupContent(pin, pinData) {
      // display info about pin
      const dataDisplay = document.createElement("p");
      dataDisplay.setAttribute("class", "increasedLineHeight");
      dataDisplay.innerHTML = [
        `PIN: ${pin}`,
        `Address: ${pinData.property_address}`,
        `Zip Code: ${pinData.property_zip}`,
        `Ward: ${pinData.ward}`,
        `Property Status: ${pinData.property_status}`,
        `Record Last Updated: ${pinData['last_update_aksk-kvfp']}`,
        `Property Details: <a href="https://www.cookcountyassessor.com/pin/${pin}" target="_blank" rel="noopener">Assessor's Office</a>`
      ].join("<br>");
      // allow user to add or remove pin from saved pins
      const savedPinButton = document.createElement("button");
      savedPinButton.setAttribute("type", "button");
      savedPinButton.innerText = savedPins.has(pin) ? "Remove from Saved Pins" : "Add to Saved PINs";
      savedPinButton.addEventListener("click", (event) => {
        if (!savedPins.has(pin)) {
          addSavedPin(pin);
          savedPinButton.innerText = "Remove from Saved PINs";
        } else {
          removeSavedPin(pin);
          savedPinButton.innerText = "Add to Saved PINs";
        }
      });
      // center savedPinButton
      const savedPinButtonDiv = document.createElement("div");
      savedPinButtonDiv.setAttribute("class", "center");
      savedPinButtonDiv.appendChild(savedPinButton);
      // return div with dataDisplay and savedPinButton
      const popupDiv = document.createElement("div");
      popupDiv.appendChild(dataDisplay);
      popupDiv.appendChild(savedPinButtonDiv);
      return popupDiv;
    }

    // add marker layers
    addMarkerLayer("ward20", "City-Owned PINs in Ward 20", "#0000ff", parentMarkerCluster, cityOwnedLayers);
    addMarkerLayer("otherWards", "City-Owned PINs in Other Wards", "#9900cc", parentMarkerCluster, cityOwnedLayers);
    addMarkerLayer("sunshineGospelPin", "Sunshine Gospel Ministries", "#0099cc", null, sunshineGospelLayers);
    addMarkerLayer("sunshineGospelCircle", "Circle around Sunshine Gospel Ministries", "#00ace6", null, sunshineGospelLayers);

    // add marker for Sunshine Gospel Ministries
    addMarker(
      "sunshineGospelPin",
      sunshineGospel,
      generateIconNewVer2(sunshineGospelLayers.get("sunshineGospelPin").color, sunshineGospel.pin),
      sunshineGospelLayers.get("sunshineGospelPin"),
      "<a href='https://www.sunshinegospel.org/' target='_blank' rel='noopener'>Sunshine Gospel Ministries</a>"
    );
    
    // add circle of ~2 mi. radius centered at Sunshine Gospel Ministries
    const sgmCircle = L.circle([sunshineGospel.latitude, sunshineGospel.longitude], {
      radius: 3000,
      color: sunshineGospelLayers.get("sunshineGospelCircle").color,
      fillOpacity: 0.2,
    }).addTo(sunshineGospelLayers.get("sunshineGospelCircle").layer);

    // add city-owned PINs to map
    for (const pin of Object.keys(data)) {
      const datum = data[pin];
      const layerKey = (datum.ward > 0 && datum.ward <= 50)
        ? (datum.ward === 20) ? "ward20" : "otherWards"
        : null;
      if (!layerKey) {
        console.log(`Error: the PIN ${pin} could not be categorized.`);
      } else {
        const layerObject = cityOwnedLayers.get(layerKey);
        addMarker(
          layerKey,
          datum,
          generateIconNewVer2(layerObject.color, pin),
          layerObject,
          getMarkerPopupContent(pin, data[pin]),
        );
      }
    }

    // add layer control
    const layerControl = L.control.layers(
      {
        "OpenStreetMap" : osmtiles,
      },
      null,
      {
        collapsed : false,
        hideSingleBase : true,
      }
    ).addTo(map);

    // Add overlays to map and map layer control
    addOverlaysToMap(cityOwnedLayers.values(), layerControl, map);
    addOverlaysToMap(sunshineGospelLayers.values(), layerControl, map);
    addOverlaysToMap(geoJSONLayers.values(), layerControl, map);

    // allow the user to change the radius of sgmCircle
    const sgmRadiusInput = document.getElementById("sgmRadiusInput");
    const sgmRadiusMessage = document.getElementById("sgmRadiusMessage");
    sgmRadiusInput.value = sgmCircle.getRadius() / 1000; // meters to kilometers
    document.getElementById("sgmRadiusSetButton").addEventListener("click", (event) => {
      const newRadius = parseFloat(sgmRadiusInput.value);
      if (!isNaN(newRadius)) {
        // valid float
        sgmCircle.setRadius(newRadius * 1000); // kilometers to meters
        const sgmCircleLayer = sunshineGospelLayers.get("sunshineGospelCircle").layer;
        if (!map.hasLayer(sgmCircleLayer)) {
          sgmCircleLayer.addTo(map);
        }
        sgmRadiusInput.classList.replace("invalidInput", "validInput");
        displayMessage(sgmRadiusMessage, `Success! The radius has been set to ${newRadius} km.`, "green");
      } else {
        // invalid float
        sgmRadiusInput.classList.replace("validInput", "invalidInput");
        displayMessage(sgmRadiusMessage, "Error: input must be a valid number.", "red");
      }
    });

    // allow the user to zoom in on an inputted PIN
    const pinSearchInput = document.getElementById("pinSearchInput");
    const pinSearchMessage = document.getElementById("pinSearchMessage");
    document.getElementById("pinSearchButton").addEventListener("click", (event) => {
      // try to find PIN in list of city-owned PINs (ignoring '-' characters)
      const pin = pinSearchInput.value.replace(/-/g,'');
      const pinData = data[pin];
      if (pinData) {
        // if the PIN was found, zoom in, alert the user, and open the PIN's marker popup
        const pinLayer = cityOwnedLayers.get(pinData.layerName).layer;
        if (!map.hasLayer(pinLayer)) {
          pinLayer.addTo(map);
        }
        parentMarkerCluster.zoomToShowLayer(
          pinData.marker,
          () => {
            pinSearchInput.classList.replace("invalidInput", "validInput");
            displayMessage(pinSearchMessage, "Success! The results for your search have been displayed on the map.", "green");
            pinData.marker.openPopup();
          },
        );
      } else {
        // if the PIN could not be found, alert the user
        pinSearchInput.classList.replace("validInput", "invalidInput");
        displayMessage(pinSearchMessage, "Error: the inputted PIN could not be found on the map.", "red");
      }
    });

    // allow user to export saved pins
    const exportSavedPinsMessage = document.getElementById("exportSavedPinsMessage");
    const exportFileName = "saved_pins.json";
    document.getElementById("exportSavedPinsButton").addEventListener("click", (event) => {
      if (savedPins.size > 0) {
        exportSavedPins(exportFileName);
        displayMessage(exportSavedPinsMessage, `Success! Your Saved PINs list has been exported as "${exportFileName}".`, "green");
      } else {
        displayMessage(exportSavedPinsMessage, "Your Saved PINs list is empty. You can save a PIN by clicking on its marker on the map and selecting \"Add to Saved PINs\".", "red");
      }
    });

    // allow user to clear saved pins
    document.getElementById("clearSavedPinsButton").addEventListener("click", (event) => {
      if (savedPins.size > 0 && window.confirm("Are you sure you want to remove all saved PINs? This action cannot be undone.")) {
        clearSavedPins();
      }
    });

    let savedPinsTab = null;

    // allow user to view saved pins in separate window
    // reference: https://developer.mozilla.org/en-US/docs/Web/API/Window/open (public domain)
    document.getElementById("viewSavedPinsButton").addEventListener("click", (event) => {
      if (savedPinsTab == null || savedPinsTab.closed) {
        savedPinsTab = window.open("", "View Saved PINs");
        savedPinsTab.document.title = "View Saved PINs";
      }
      savedPinsTab.document.write(`<p>You have ${savedPins.size} saved PINs.`);
      savedPinsTab.document.close();
      savedPinsTab.focus();
    });

    // add map description
    document.getElementById("mapDescription").innerHTML = "This is a map of properties owned by the "
      + "City of Chicago that may be for sale and of interest to Sunshine Gospel Ministries' Housing "
      + "Equity Initiative. The data for the markers on this map comes from the Chicago Data Portal's "
      + `<a href="https://data.cityofchicago.org/Community-Economic-Development/City-Owned-Land-Inventory/aksk-kvfp" target="_blank" rel="noopener">City-Owned Land Inventory dataset</a>`
      + " and Cook County's "
      + `<a href="https://datacatalog.cookcountyil.gov/Property-Taxation/Assessor-Archived-05-11-2022-Property-Locations/c49d-89sn" target="_blank" rel="noopener">Property Locations dataset</a>`
      + ` (accessed on ${accessDateTime}). The ward boundaries data comes from the Chicago Data Portal's `
      + `<a href="https://data.cityofchicago.org/Facilities-Geographic-Boundaries/Boundaries-Wards-2015-/sp34-6z76" target="_blank" rel="noopener">Ward Boundaries dataset</a>`
      + ` (accessed on ${wardBoundariesAccessTime}).`
      + " Click on each marker to view more information about the property it represents,"
      + " and add it to your Saved PINs list by selecting \"Add to Saved PINs\""
      + ` (saved PINs are marked with a checkmark on the map and can be exported for use in other`
      + " applications).";

      // store saved pins in local storage before unloading page
      window.addEventListener("beforeunload", (event) => {
        localStorage.setItem("city-owned-map-saved-pins", JSON.stringify([...savedPins]));
      });
  </script>   

</body>

</html>

<!-- references:
  https://github.com/Leaflet/Leaflet/tree/main/docs/examples (BSD 2-Clause license)
  https://github.com/Leaflet/Leaflet.markercluster (MIT license)
  https://github.com/ghybs/Leaflet.FeatureGroup.SubGroup (BSD 2-Clause license)
-->
