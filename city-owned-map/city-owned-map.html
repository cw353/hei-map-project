<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>HEI-Relevant City-Owned PINs</title>

  <!-- Leaflet CDN -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css"
    integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ=="
    crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"
    integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ=="
    crossorigin=""></script>

  <!-- Leaflet.markercluster CDN -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css"
    integrity="sha512-RLEjtaFGdC4iQMJDbMzim/dOvAu+8Qp9sw7QE4wIMYcg2goVoivzwgSZq9CsIxp4xKAZPKh5J2f2lOko2Ze6FQ=="
    crossorigin=""/>
  <!-- non-minified - switch for deployment !!! -->
  <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster-src.js"
    integrity="sha512-gu3GZbPnPGREFcXgxeWVbp9Oeq3Tdvskd5PaQ0q//PCDMsa0WSSABIqLDwF5ebaDBfJbcM+lamNEe8ln9dPWwA=="
    crossorigin=""></script>
  <!-- minified -->
  <!--script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"
    integrity="sha512-MQlyPV+ol2lp4KodaU/Xmrn+txc1TP15pOBF/2Sfre7MRsA/pB4Vy58bEqe9u7a7DczMLtU5wT8n7OblJepKbg=="
    crossorigin=""></script-->

  <!-- Leaflet.FeatureGroup.SubGroup CDN -->
  <script src="https://unpkg.com/leaflet.featuregroup.subgroup@1.0.2/dist/leaflet.featuregroup.subgroup.js"
    integrity="sha512-gUiI5CXREIHHGko8AdlPYADT5MHvcCuqee1pjKR4qVcw69zVI+WvrnJcCxwU8JajpJoBjpvPIAGfDVFoQJhDfw=="
    crossorigin=""></script>

  <!-- External files for data -->
  <script src="data.js"></script>
  <script src="ward_boundaries_sp34-6z76.js"></script>
  
  <style>
    #map {
      position: relative;
      width: 100%;
      height: 600px;
      left: 0;
      top: 0;
    }

    /* Modified from https://github.com/Leaflet/Leaflet.markercluster/blob/master/dist/MarkerCluster.Default.css (MIT license) */
    .marker-cluster {
      background-clip: padding-box;
      border-radius: 20px;
      background-color: rgba(253, 156, 115, 0.6);
    }
    
    /* Modified from https://github.com/Leaflet/Leaflet.markercluster/blob/master/dist/MarkerCluster.Default.css (MIT license) */
    .marker-cluster div {
      width: 30px;
      height: 30px;
      margin-left: 5px;
      margin-top: 5px;
      background-color: rgba(241, 128, 23, 0.6);
      text-align: center;
      border-radius: 15px;
      font: 12px "Helvetica Neue", Arial, Helvetica, sans-serif;
    }

    /* Modified from https://github.com/Leaflet/Leaflet.markercluster/blob/master/dist/MarkerCluster.Default.css (MIT license) */
    .marker-cluster span {
      line-height: 30px;
    }
  </style>
    
</head>

<body>

  <form id="sgmCircleForm">
    <label>
      Radius (in meters)
      <input type="number" name="radiusInput"/>
    </label>
    <button type="button" name="applyChangesButton">
      Apply Changes
    </button>
  </form>
  
  <div id="map"></div>

  <script>

    // create map
    const map = L.map("map", {
      center: [41.783, -87.621],
      zoom: 13,
      scrollWheelZoom: false,
      doubleClickZoom: false,
    });

    // add tiles to map - reference: https://leafletjs.com/examples/layers-control/
    const osmtiles = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "&copy; <a href='http://www.openstreetmap.org/copyright'>OpenStreetMap</a>"
    }).addTo(map);
      
    /**
     * Generate a custom icon with the specified fill color.
     * The icon is based on https://commons.wikimedia.org/wiki/File:Octicons-location.svg (MIT license).
     * Resources referenced: https://onestepcode.com/leaflet-markers-svg-icons/.
     * @param color The fill color.
     * @returns The custom icon with the specified fill color.
     */
    function generateIcon(color) {
      const width = 24;
      const height = 48;
      return L.divIcon({
        className: "custom_divicon",
        iconSize: [width, height],
        iconAnchor: [width/2, height],
        popupAnchor: [0,-(height/5)*4],
        html:
          `<svg
            width="${width}"
            height="${height}"
            viewBox="0 0 640 1024"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M320 0c-177 0-320 143-320 320s160 416 320 704c160-288 320-527 320-704s-143-320-320-320z m0 448c-71 0-128-57-128-128s57-128 128-128 128 57 128 128-57 128-128 128z"
              fill=${color}
              stroke=black
              stroke-width=10px
            />
          </svg>`
      });
    };

    /* Create ward boundary layers */
    const geoJSONLayers = new Map();
    
    function addGeoJSONLayer(key, label, color, layer) {
      geoJSONLayers.set(key, {
        layer: layer,
        label: label,
        color: color,
      });
    };
       
    /* Function to be run for each ward feature */
    const onEachWard = (feature, layer) => {
      if (feature.properties && feature.properties.ward) {
        layer.bindPopup("Ward " + feature.properties.ward);
      }
    };

    // Add ward boundaries layer
    addGeoJSONLayer("wardBoundaries", "Ward Boundaries", "black", L.geoJSON(
      wardBoundaries,
      {
        style: {
          color: "black",
          weight: 2,
          fillOpacity: 0,
        },
        onEachFeature: (feature, layer) => {
          onEachWard(feature, layer);
          // Add shaded layer for Ward 20
          if (feature.properties && feature.properties.ward === "20") {
            const ward20FillColor = "#e68a00";
            addGeoJSONLayer("ward20Fill", "Ward 20 (shaded)", ward20FillColor, L.geoJSON(
              feature,
              {
                style: {
                  color: "black",
                  weight: 2,
                  fillColor: ward20FillColor,
                  fillOpacity: 0.3,
                },
                onEachFeature: onEachWard,
              }
            ));
          }
        }
      }
    ));

    const parentCluster = L.markerClusterGroup({
      maxClusterRadius: 50,
    }).addTo(map);

    // map of marker layers
    const markerLayers = new Map();

    /**
     * Helper function to add a new marker layer to markerLayers.
     * @param key The key for the map entry.
     * @param label The label to associate with the marker layer.
     * @param color The color to associate with the marker layer.
     * @param useCluster Whether or not to use marker clustering with this marker layer. 
     */
    function addMarkerLayer(key, label, color, useCluster) {
      markerLayers.set(key, {
        layer: useCluster ? L.featureGroup.subGroup(parentCluster) : L.layerGroup(),
        label: label,
        color: color,
        markerCount: 0,
      });
    }

    addMarkerLayer("sunshineGospel", "Sunshine Gospel Ministries", "#ff0000", false);
    addMarkerLayer("sunshineGospelCircle", "2-Mile Radius Around Sunshine Gospel Ministries", "#ff0000", false);
    addMarkerLayer("ward20_and_zip60637", "Ward 20, Zip Code 60637", "#9900cc", true);
    addMarkerLayer("ward20", "Ward 20, Other Zip Codes", "#0000ff", true);
    addMarkerLayer("zip60637", "Other Wards, Zip Code 60637", "#009900", true);

    const layerControl = L.control.layers(
      {
        "OpenStreetMap" : osmtiles,
      },
      null,
      {
        collapsed : false,
        hideSingleBase : true,
      }
    ).addTo(map);

    /**
     * Add a marker to the specified marker layer.
     * @param layerKey The key for the marker layer.
     * @param latlng The coordinates for the marker.
     * @param popupContent The content for the marker popup.
     * Postcondition: The marker has been added to the specified marker layer and the marker
     * property for that layer has been incremented by one.
     */
    function addMarker(layerKey, latlng, popupContent) {
      const markerLayer = markerLayers.get(layerKey);
      L.marker(latlng, {
        icon: generateIcon(markerLayer.color)
      })
        .bindPopup(popupContent)
        .addTo(markerLayer.layer);
      markerLayer.markerCount++;
    }

    // add marker for Sunshine Gospel Ministries
    addMarker("sunshineGospel", [sunshineGospel.latitude, sunshineGospel.longitude], "Sunshine Gospel Ministries");
    
    // add circle of ~2 mi. radius centered at Sunshine Gospel Ministries
    const sgmCircle = L.circle([sunshineGospel.latitude, sunshineGospel.longitude], {
      radius: 3218, // roughly 2 mi. radius
      color: markerLayers.get("sunshineGospelCircle").color,
      fillOpacity: 0.1,
    }).addTo(markerLayers.get("sunshineGospelCircle").layer);

    for (const pin of Object.keys(data)) {
      const datum = data[pin];
      const layerKey = (datum.ward === 20 && datum.property_zip.startsWith("60637"))
        ? "ward20_and_zip60637"
        : (datum.ward === 20)
          ? "ward20"
          : (datum.property_zip.startsWith("60637"))
            ? "zip60637"
            : null;
      if (!layerKey) {
        console.log(`Error: ${pin} could not be categorized.`);
      } else {
        addMarker(
          layerKey,
          [datum.latitude, datum.longitude],
          `PIN: ${pin}, zip code: ${datum.property_zip}, ward: ${datum.ward}, address: ${datum.property_address}`,
        );
      }
    }

    /**
     * Helper function to add all overlays in the specified Map data structure to the map and the map's layer control.
    */
    function addOverlaysToMap(overlayMap) {
      // Helper function to generate the label for a layer
      function getOverlayLabel(layerInfo) {
        // include the layer color and name in the overlay label
        let label = `<span style='color: ${layerInfo.color}'>&#9724;</span> ${layerInfo.label}`;
        // if the layer has a marker count greater than zero, include it in the overlay label
        if (layerInfo.markerCount && layerInfo.markerCount > 0) {
          label += ` (${layerInfo.markerCount} marker${layerInfo.markerCount > 1 ? "s" : ""})`;
        }
        return label;
      }
      // add each overlay in overlayMap to the map and the map's layer control
      for (const [key, val] of overlayMap.entries()) {
        layerControl.addOverlay(
          val.layer,
          getOverlayLabel(val),
        );
        val.layer.addTo(map);
      }

    }

    // Add overlays to map and map layer control
    addOverlaysToMap(geoJSONLayers);
    addOverlaysToMap(markerLayers);

    const sgmCircleForm = document.getElementById("sgmCircleForm");
    sgmCircleForm.radiusInput.value = sgmCircle.getRadius();
    sgmCircleForm.applyChangesButton.addEventListener("click", (event) => {
      const newRadius = parseFloat(sgmCircleForm.radiusInput.value);
      if (!isNaN(newRadius)) {
        sgmCircleForm.radiusInput.style.backgroundColor = null;
        sgmCircle.setRadius(newRadius);
      } else {
        sgmCircleForm.radiusInput.style.backgroundColor = "red";
      }
    });

  </script>   

</body>

</html>

<!-- references:
  https://github.com/Leaflet/Leaflet/tree/main/docs/examples (BSD 2-Clause license)
  https://github.com/Leaflet/Leaflet.markercluster (MIT license)
  https://github.com/ghybs/Leaflet.FeatureGroup.SubGroup (BSD 2-Clause license)
-->
