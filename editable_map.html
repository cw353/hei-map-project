<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Editable Map</title>

  <!-- Leaflet CDN -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css"
    integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ=="
    crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"
    integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ=="
    crossorigin=""></script>
  <script src="helper_functions.js"></script>

  <style>
    #map {
      position: relative;
      width: 100%;
      height: 500px;
      left: 0;
      top: 0;
    }

    .flexColumn {
      display: flex;
      flex-direction: column;
    }

    .flexRow {
      display: flex;
      flex-direction: row;
    }

    button {
      margin: 5px;
      border-color: grey;
      border-style: solid;
    }

    .globalButtonDiv {
      margin: 10px;
    }

    .warning {
      background-color: #ff5370;
    }

    .defaultOption {
      background-color: #82aaff;
    }

    .warning:hover, .defaultOption:hover {
      color: #eeffff;
    }

    .iconButton {
      padding-top: 2px;
      padding-bottom: 2px;
      vertical-align: middle;
      align-items: center;
      text-align: center;
    }

    /* reference: https://stackoverflow.com/a/2920238 (CC BY-SA 3.0) */
    .bgIconButton {
      background-image: url(https://upload.wikimedia.org/wikipedia/commons/a/a0/Font_Awesome_5_regular_arrow-alt-circle-up.svg);
      background-position: left center;
      background-repeat: no-repeat;
      background-origin: padding-box;
      background-size: 20px 20px;
      height: 30px;
      padding-left: 30px;
      vertical-align: middle;
      text-align: center;
      align-items: center;
    }

    .transparentButton {
      border: none;
      background-color: transparent;
    }

    .transparentButton:hover {
      background-color: lightgrey;
    }

    .alignRight {
      float: right;
    }

  </style>
    
</head>

<body>

  <!-- 
    https://commons.wikimedia.org/wiki/Category:SVG_arrow_icons:_Noun_project
    https://commons.wikimedia.org/wiki/File:Download_(4501)_-_The_Noun_Project.svg
    https://commons.wikimedia.org/wiki/File:Download_(89523)_-_The_Noun_Project.svg,
    https://commons.wikimedia.org/wiki/File:Noun_project_-_Upload.svg
    https://commons.wikimedia.org/wiki/File:Upload_(89524)_-_The_Noun_Project.svg
  -->
  <div id="globalButtonDiv" class="globalButtonDiv flexRow">
    <button type="button" style="text-align: center">
      <div class="bgIconButton">Import Markers</div>
      <!-- https://commons.wikimedia.org/wiki/File:Font_Awesome_5_regular_arrow-alt-circle-up.svg (CC BY 4.0 license)-->
      <!--img
        src="https://upload.wikimedia.org/wikipedia/commons/a/a0/Font_Awesome_5_regular_arrow-alt-circle-up.svg"
        alt="import icon"
        width="20px"
        height="20px"
      /-->
    </button>
    <button type="button" class="bgIconButton">
      <!-- https://commons.wikimedia.org/wiki/File:Font_Awesome_5_regular_arrow-alt-circle-up.svg (CC BY 4.0 license)-->
      <!--img
      src="https://upload.wikimedia.org/wikipedia/commons/a/a0/Font_Awesome_5_regular_arrow-alt-circle-up.svg"
      alt="import icon"
      width="20px"
      height="20px"
      style="transform: rotate(0.5turn)"
    /-->
      Export Markers
    </button>

    <button type="button" class="iconButton">
      <!-- https://commons.wikimedia.org/wiki/File:Font_Awesome_5_regular_arrow-alt-circle-up.svg (CC BY 4.0 license)-->
      <img
        src="https://upload.wikimedia.org/wikipedia/commons/a/a0/Font_Awesome_5_regular_arrow-alt-circle-up.svg"
        alt="import icon"
        width="20px"
        height="20px"
      />
      Import Markers
    </button>
    <button type="button" class="iconButton">
      <!-- https://commons.wikimedia.org/wiki/File:Font_Awesome_5_regular_arrow-alt-circle-up.svg (CC BY 4.0 license)-->
      <img
      src="https://upload.wikimedia.org/wikipedia/commons/a/a0/Font_Awesome_5_regular_arrow-alt-circle-up.svg"
      alt="import icon"
      width="20px"
      height="20px"
      style="transform: rotate(0.5turn)"
    />
      Export Markers
    </button>

    <button type="button">
      Delete Markers
    </button>
  </div>
  <div id="map"></div>

  <script>

    // create map
    const map = L.map("map", {
      center: [41.783, -87.621],
      zoom: 5,
    });

    // add tiles to map
    const tiles = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "Â© OpenStreetMap"
    }).addTo(map);

    // data structure to track markerRecords
    const markerRecords = new Map();

    // create marker layer
    const markerLayerGroup = L.layerGroup().addTo(map);

    
    /**
     * Generate a custom icon with the specified fill color.
     * The icon is based on https://commons.wikimedia.org/wiki/File:Octicons-location.svg (MIT license).
     * Resources referenced: https://onestepcode.com/leaflet-markers-svg-icons/.
     * @param color The fill color.
     * @returns The custom icon with the specified fill color.
     */
     function generateIcon(color) {
      const width = 26;
      const height = 50;
      return L.divIcon({
        className: "custom_divicon",
        iconSize: [width, height],
        iconAnchor: [width/2, height],
        popupAnchor: [0,-(height/5)*4],
        html:
          `<svg
            width="${width}"
            height="${height}"
            viewBox="0 0 640 1024"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M320 0c-177 0-320 143-320 320s160 416 320 704c160-288 320-527 320-704s-143-320-320-320z m0 448c-71 0-128-57-128-128s57-128 128-128 128 57 128 128-57 128-128 128z"
              fill=${color}
            />
          </svg>`
      });
    }

    function updateMarkerPopupContent(marker, newContent) {
      marker.closePopup();
      marker.setPopupContent(newContent);
    }

    function getEditMarkerUI(latlng) {
      // !!! account for case where marker doesn't yet exist?
      const latlngString = JSON.stringify(latlng);
      const markerRecord = markerRecords.get(latlngString);
      const form = createElement({
        // input for editing marker label
        tag: "form",
        attributes: [["id", "editMarkerForm"], ["class", "editMarkerForm"]],
        children: [
          createElement({
            tag: "button",
            attributes: [["type", "button"], ["class", "transparentButton alignRight"]],
            eventListeners: [["click", () => {
              if (window.confirm("Are you sure you want to delete this marker?")) {
                // close popup before deleting it
                markerRecord.markerReference.closePopup();
                // delete marker record
                markerRecords.delete(latlngString);
                // remove marker from markerLayerGroup
                markerRecord.markerReference.removeFrom(markerLayerGroup);
              }
            }]],
            children: [createElement({
              tag: "img",
              attributes: [
                // Source: https://commons.wikimedia.org/wiki/File:Toicon-icon-lines-and-angles-discard.svg (CC BY 4.0 license)
                ["src", "https://upload.wikimedia.org/wikipedia/commons/b/bb/Toicon-icon-lines-and-angles-discard.svg"],
                ["alt", "Delete Marker"],
                ["title", "Delete Marker"],
                ["width", "30px"],
                ["height", "30px"],
                ["class", "icon"],
              ]
            })]
          }),
          createElement({
            tag: "p",
            children: [
              createElement({
                tag: "label",
                text: "Label: ",
                children: [
                  createElement({
                    tag: "input",
                    attributes: [
                      ["name", "label"], ["type", "text"],
                      ["value", markerRecord.label], // populate input with current label
                    ],
                  })
                ],
              })
            ]
          }),
          // input for editing marker color
          createElement({
            tag: "p",
            children: [
              createElement({
                tag: "label",
                text: "Color: ",
                children: [
                  createElement({
                    tag: "input",
                    attributes: [
                      ["name", "color"], ["type", "color"],
                      ["value", markerRecord.color], // populate input with current label
                    ],
                  })
                ],
              })
            ]
          }),
          // textarea for editing marker notes
          createElement({
            tag: "p",
            children: [
              createElement({
                tag: "label",
                text: "Notes:",
                attributes: [["class", "flexColumn"]],
                children: [
                  createElement({
                    tag: "textarea",
                    text: markerRecord.notes, // populate textarea with current notes
                    attributes: [["name", "notes"], ["rows", "4"], ["cols", "20"], ["class", "flexColumn"]],
                  })
                ],
              }),
            ],
          }),
          createElement({
            tag: "button",
            text: "Save Changes",
            attributes: [["type", "button"], ["class", "defaultOption"]],
            eventListeners: [
              ["click", () => {
                markerRecords.set(latlngString, {
                  markerReference: markerRecord.markerReference, // !!! edit this later to account for case where marker does not exist?
                  label: form.elements["label"].value,
                  notes: form.elements["notes"].value,
                  color: form.elements["color"].value,
                });
                markerRecord.markerReference.setIcon(generateIcon(form.elements["color"].value));
                updateMarkerPopupContent(markerRecord.markerReference, getEditMarkerUI(latlng));
              }],
            ],
          }),
          createElement({
            tag: "button",
            text: "Discard Changes",
            attributes: [["type", "button"], ["class", "warning"]],
            eventListeners: [
              ["click", () => {
                console.log(form.elements["discardChangesButton"].classList);
                if (window.confirm("Are you sure you want to discard your changes?")) {
                  updateMarkerPopupContent(markerRecord.markerReference, getEditMarkerUI(latlng));
                }
              }],
            ],
          }),
        ]
      });
      return form;
    }

    function getDefaultMarkerRecord(markerReference) {
      return {
        markerReference: markerReference,
        label: "Unnamed Marker",
        notes: "",
        color: "#0000ff",
      }
    }

    /**
     * Function to run whenever the map is clicked.
     */
    function onMapClick(event) {
      const latlngString = JSON.stringify(event.latlng);
      // if a marker with these coordinates has already been added to the map, open its popup
      // otherwise, add a marker to the map at these coordinates
      if (markerRecords.has(latlngString)) {
        markerRecords.get(latlngString).markerReference.openPopup();
      } else {
        const popup = L.popup({
          keepInView : true,
          closeButton : false,
          autoClose : false,
          closeOnEscapeKey : false,
          closeOnClick : false,
        });
        // create marker
        const marker = L.marker(event.latlng, {
          icon : generateIcon("#0000ff"),
        });
        // add marker to map
        markerRecords.set(latlngString, getDefaultMarkerRecord(marker));
        popup.setContent(getEditMarkerUI(event.latlng));
        marker
          .bindPopup(popup)
          .addTo(markerLayerGroup)
          .openPopup();
      }
    }

    // add click event listener to map
    map.on("click", onMapClick);
    
    /*document.getElementById("controlButtons").appendChild(createButton("Clear markerRecords", () => {
      // also reset markerRecords set
      markerLayerGroup.clearLayers();
      markerRecords.clear();
      console.log("markerLayerGroup cleared");
    }));*/

    // TODO: consider making markerRecords draggable (would have to add "move" event listener)
  </script>   

</body>

</html>
<!-- references:
  https://github.com/Leaflet/Leaflet/tree/main/docs/examples (BSD 2-Clause license)
  https://stackoverflow.com/a/59052053 (CC BY-SA 4.0 license)
-->
