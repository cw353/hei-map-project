<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Editable Map</title>

  <!-- Leaflet CDN -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css"
    integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ=="
    crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"
    integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ=="
    crossorigin=""></script>
  <script src="helper_functions.js"></script>

  <style>
    #map {
      position: relative;
      width: 100%;
      height: 500px;
      left: 0;
      top: 0;
    }

    .flexColumn {
      display: flex;
      flex-direction: column;
    }

    .flexRow {
      display: flex;
      flex-direction: row;
    }

    button {
      margin: 5px;
      border-color: grey;
      background-color: lightgrey;
      border-style: solid;
    }

    button:hover {
      color: #eeffff;
      background-color: grey;
    }

    .globalButtonDiv {
      margin: 10px;
    }

    .warning {
      background-color: #fc617b;
    }

    .warning:hover {
      background-color: #fd4b68;
      border-color: #fd4b68;
    }

    .defaultOption {
      background-color: #82aaff;
    }

    .defaultOption:hover {
      background-color: #4e85fb;
      border-color: #4e85fb;
    }

    .iconButton {
      border-width: 0px;
      background-color: transparent;
    }

    .iconButton:hover {
      background-color: lightgrey;
    }

    .floatRight {
      float: right;
    }

  </style>
    
</head>

<body>

  <div id="globalButtonDiv" class="globalButtonDiv flexRow">
    <button type="button">
      Import Markers
    </button>
    <button type="button">
      Export Markers
    </button>
    <button type="button">
      Delete Markers
    </button>
  </div>

  <div id="map"></div>

  <script>

    // create map
    const map = L.map("map", {
      center: [41.783, -87.621],
      zoom: 5,
    });

    // add tiles to map
    const tiles = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "Â© OpenStreetMap"
    }).addTo(map);

    // data structure to track markerRecords
    const markerRecords = new Map();

    // create marker layer
    const markerLayerGroup = L.layerGroup().addTo(map);

    function hasMarkerRecord(recordKey) {
      for (const key of markerRecords.keys()) {
        if (markerRecords.get(key).has(recordKey)) {
          return true;
        }
      }
      return false;
    }

    function getMarkerRecord(recordKey) {
      for (const key of markerRecords.keys()) {
        if (markerRecords.get(key).has(recordKey)) {
          return markerRecords.get(key).get(recordKey);
        }
      }
      return null;
    }

    function setMarkerRecord(categoryName, recordKey, recordValue) {
      if (!(markerRecords.has(categoryName))) {
        markerRecords.set(categoryName, new Map());
      }
      markerRecords.get(categoryName).set(recordKey, recordValue);
    }

    function deleteMarkerRecord(categoryName, recordKey) {
      if (markerRecords.has(categoryName)) {
        markerRecords.get(categoryName).delete(recordKey);
      }
    }

    const categories = [
      "Unsorted",
      "Houses",
      "Vacant Lots",
    ]
    
    /**
     * Generate a custom icon with the specified fill color.
     * The icon is based on https://commons.wikimedia.org/wiki/File:Octicons-location.svg (MIT license).
     * Resources referenced: https://onestepcode.com/leaflet-markers-svg-icons/.
     * @param color The fill color.
     * @returns The custom icon with the specified fill color.
     */
     function generateIcon(color) {
      const width = 26;
      const height = 50;
      return L.divIcon({
        className: "custom_divicon",
        iconSize: [width, height],
        iconAnchor: [width/2, height],
        popupAnchor: [0,-(height/5)*4],
        html:
          `<svg
            width="${width}"
            height="${height}"
            viewBox="0 0 640 1024"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M320 0c-177 0-320 143-320 320s160 416 320 704c160-288 320-527 320-704s-143-320-320-320z m0 448c-71 0-128-57-128-128s57-128 128-128 128 57 128 128-57 128-128 128z"
              fill=${color}
            />
          </svg>`
      });
    }

    function updateMarkerPopupContent(marker, newContent) {
      marker.closePopup();
      marker.setPopupContent(newContent);
    }

    function getEditMarkerUI(latlng) {
      let unsavedChanges = false;
      const unsavedChangesListener = [
        "change",
        (event) => { unsavedChanges = true; },
        { once : true },
      ]
      // !!! account for case where marker doesn't yet exist?
      const latlngString = JSON.stringify(latlng);
      const markerRecord = getMarkerRecord(latlngString);
      const form = createElement({
        // input for editing marker label
        tag: "form",
        attributes: [["id", "editMarkerForm"], ["class", "editMarkerForm"]],
        children: [
          createElement({
            tag: "p",
            attributes: [["class", "flexRow"]],
            children: [
              createElement({
                tag: "label",
                text: "Label: ",
                children: [
                  createElement({
                    tag: "input",
                    attributes: [
                      ["name", "label"], ["type", "text"], ["size", "25"],
                      ["value", markerRecord.label], // populate input with current label
                    ],
                    eventListeners: [unsavedChangesListener],
                  })
                ],
              })
            ]
          }),
          // input for editing marker color
          createElement({
            tag: "p",
            children: [
              createElement({
                tag: "label",
                text: "Color: ",
                children: [
                  createElement({
                    tag: "input",
                    attributes: [
                      ["name", "color"], ["type", "color"],
                      ["value", markerRecord.color], // populate input with current label
                    ],
                    eventListeners: [unsavedChangesListener],
                  })
                ],
              })
            ]
          }),
          // textarea for editing marker notes
          createElement({
            tag: "p",
            children: [
              createElement({
                tag: "label",
                text: "Notes:",
                attributes: [["class", "flexColumn"]],
                children: [
                  createElement({
                    tag: "textarea",
                    text: markerRecord.notes, // populate textarea with current notes
                    attributes: [["name", "notes"], ["rows", "4"], ["cols", "20"], ["class", "flexColumn"]],
                    eventListeners: [unsavedChangesListener],
                  })
                ],
              }),
            ],
          }),
          createElement({
            tag: "div",
            attributes: [["class", "flexRow"]],
            children: [
              createElement({
                tag: "button",
                text: "Close",
                attributes: [["type", "button"]],
                eventListeners: [
                  ["click", () => {
                    if ((!unsavedChanges) || window.confirm("Are you sure you want to close this popup? Your unsaved changes will be lost.")) {
                      updateMarkerPopupContent(markerRecord.markerReference, getEditMarkerUI(latlng));
                    }
                  }],
                ],
              }),
              createElement({
                tag: "button",
                text: "Delete Marker",
                attributes: [["type", "button"], ["class", "warning"]],
                eventListeners: [["click", () => {
                  if (window.confirm("Are you sure you want to delete this marker?")) {
                    // close popup before deleting it
                    markerRecord.markerReference.closePopup();
                    // delete marker record
                    deleteMarkerRecord(markerRecord.category, latlngString);
                    markerRecords.delete(latlngString);
                    // remove marker from markerLayerGroup
                    markerRecord.markerReference.removeFrom(markerLayerGroup);
                  }
                }]],
              }),
              createElement({
                tag: "button",
                text: "Save Changes",
                attributes: [["type", "button"], ["class", "defaultOption"]],
                eventListeners: [
                  ["click", () => {
                    setMarkerRecord("Unsorted", latlngString, {
                      markerReference: markerRecord.markerReference, // !!! edit this later to account for case where marker does not exist?
                      label: form.elements["label"].value,
                      notes: form.elements["notes"].value,
                      color: form.elements["color"].value,
                    });
                    markerRecord.markerReference.setIcon(generateIcon(form.elements["color"].value));
                    updateMarkerPopupContent(markerRecord.markerReference, getEditMarkerUI(latlng));
                  }],
                ],
              }),
            ]
          }),
        ]
      });
      return form;
    }

    function getDefaultMarkerRecord(markerReference) {
      return {
        markerReference: markerReference,
        category: "Unsorted",
        label: "Unnamed Marker",
        notes: "",
        color: "#0000ff",
      }
    }

    /**
     * Function to run whenever the map is clicked.
     */
    function onMapClick(event) {
      const latlngString = JSON.stringify(event.latlng);
      // if a marker with these coordinates has already been added to the map, open its popup
      // otherwise, add a marker to the map at these coordinates
      const markerRecord = getMarkerRecord(latlngString);
      if (markerRecord) {
        markerRecord.markerReference.openPopup();
      } else {
        const popup = L.popup({
          keepInView : true,
          closeButton : false,
          autoClose : false,
          closeOnEscapeKey : false,
          closeOnClick : false,
        });
        // create marker
        const marker = L.marker(event.latlng, {
          icon : generateIcon("#0000ff"),
        });
        // add marker record
        setMarkerRecord("Unsorted", latlngString, getDefaultMarkerRecord(marker));
        // add marker to map
        popup.setContent(getEditMarkerUI(event.latlng));
        marker
          .bindPopup(popup)
          .addTo(markerLayerGroup)
          .openPopup();
      }
    }

    // add click event listener to map
    map.on("click", onMapClick);
    
    /*document.getElementById("controlButtons").appendChild(createButton("Clear markerRecords", () => {
      // also reset markerRecords set
      markerLayerGroup.clearLayers();
      markerRecords.clear();
      console.log("markerLayerGroup cleared");
    }));*/

    // TODO: consider making markerRecords draggable (would have to add "move" event listener)
  </script>   

</body>

</html>
<!-- references:
  https://github.com/Leaflet/Leaflet/tree/main/docs/examples (BSD 2-Clause license)
  https://stackoverflow.com/a/59052053 (CC BY-SA 4.0 license)
-->
