<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="author" content="Claire Wagner (Summer 2022 Wheaton College Research Team)">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Map of Properties of Interest to HEI</title>
  
  <!-- jQuery -->
  <!--script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"
    integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ=="
    crossorigin=""></script-->
  <script src="offline/jquery-3.6.0.js"></script>
    
</head>

<body>

  <style>
    #loadingDiv {
      justify-content: center;
      align-items: center;
      text-align: center;
    }

    #loadingText {
      font-size: 5em;
      font-style: italic;
      margin-top: 50px;
      margin-bottom: 25px;
    }
  </style>

  <div id="loadingDiv" class="center">
    <p id="loadingText">
      Please wait for the map to load...
    </p>
    <svg  xmlns="http://www.w3.org/2000/svg" width="400" height="400" viewBox="0 0 100 100">
      <title>Loading Icon (Azizsoft, CC BY-SA 4.0)</title>
      <desc>Azizsoft, CC BY-SA 4.0, via Wikimedia Commons (https://upload.wikimedia.org/wikipedia/commons/0/08/Loadin_8_part.svg)</desc>
      <style type="text/css">
        .c{cy:50px;cx:50px;r:35px;fill:none;stroke-width:15;stroke-dashoffset:-4;stroke:#000;}.a{opacity: 0.2;stroke-dasharray:20 7.5;}
        .b{stroke-dasharray:20 200;transform-origin:50px;animation:d 1s steps(8) 0s infinite;}
        @keyframes d{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
      </style>
      <circle class="a c"/><circle class="b c"/>
    </svg>
  </div>

  <div id="pageContent">
    
    <div id="pageHeader"></div>
    <div id="tabDiv"></div>
    
    <div id="mapTab">
      <div id="additionalMapControlsContainer" class="formContainer">
        <div id="additionalMapControls">
          <div id="pinSearchBarDiv"></div>
          <div id="highlightSelectDiv"></div>
          <div id="radiiInputDiv"></div>
        </div>
      </div>
      <div id="map"></div>
    </div>

    <div id="favoritedMarkersTab">
      <p class="italic">
        To add a marker to your Favorited Markers, click on the marker on the map. If the marker can be added to your Favorited Markers, a popup with a button labeled "Add to Favorited Markers" will appear. Click the button to add the marker to your Favorited Markers.
      </p>
      <p id="favoritedMarkersOverviewParagraph" class="italic"></p>
      <div id="favoritedMarkersDetailsDiv">
        <div id="favoritedMarkersButtonsDiv"></div>
        <div id="favoritedMarkersTableDiv" class="center"></div>
      </div>
    </div>
    <div id="aboutMapTab">
      <div id="datasetTableDiv" class="center"></div>
    </div>

  </div>

  <script>
    $("#pageContent").hide();
  </script>

  <!-- Leaflet CDN -->
  <!--link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css"
    integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ=="
    crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"
    integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ=="
    crossorigin=""></script-->

  <!-- Leaflet.markercluster CDN -->
  <!--link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css"
    integrity="sha512-RLEjtaFGdC4iQMJDbMzim/dOvAu+8Qp9sw7QE4wIMYcg2goVoivzwgSZq9CsIxp4xKAZPKh5J2f2lOko2Ze6FQ=="
    crossorigin=""/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css"
    integrity="sha512-BBToHPBStgMiw0lD4AtkRIZmdndhB6aQbXpX7omcrXeG2PauGBl2lzq2xUZTxaLxYz5IDHlmneCZ1IJ+P3kYtQ=="
    crossorigin=""/>
  <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"
    integrity="sha512-MQlyPV+ol2lp4KodaU/Xmrn+txc1TP15pOBF/2Sfre7MRsA/pB4Vy58bEqe9u7a7DczMLtU5wT8n7OblJepKbg=="
    crossorigin=""></script-->

  <!-- Leaflet.MarkerCluster.LayerSupport CDN -->
  <!--script src="https://unpkg.com/leaflet.markercluster.layersupport@2.0.1/dist/leaflet.markercluster.layersupport.js"
    integrity="sha512-Utd3nyu+vSSF4E6z/hcIzoi2mCedtng1MTF2sZWLnlL2BCwSyyvwT2otaWEiVmkgCpfTy6C/RVxo5WIoJ9zY3Q=="
    crossorigin=""></script-->

  <!-- Leaflet.Fullscreen CDN -->
  <!--link rel="stylesheet" href="https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/leaflet.fullscreen.css"
    integrity="sha512-Tbna5DrK+N26ZZczWjdHj7BHyU3vUAjA7JsGhIyTM/7jBiy4f4DbiScuLQxaxB51+Gh/+a+Z7AwQmh2FyafjLg=="
    crossorigin=""/>
  <script src="https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/Leaflet.fullscreen.min.js"
    integrity="sha512-gyvCiKy2sIRwqd5QeTyyeJBTPx5OQdyluEFSIe1KnKDi0DM0w/T+T8iczSYRRcwmMYGVixYL2QGKJ+8XylbyTA=="
    crossorigin=""></script-->
  
  <!-- Local copies of libraries and plugins available via CDN -->
  <link rel="stylesheet" href="offline/leaflet/leaflet.css"/>
  <script src="offline/leaflet/leaflet-src.js"></script>
  <link rel="stylesheet" href="offline/leaflet/plugins/MarkerCluster/MarkerCluster.css"/>
  <link rel="stylesheet" href="offline/leaflet/plugins/MarkerCluster/MarkerCluster.Default.css"/>
  <script src="offline/leaflet/plugins/MarkerCluster/leaflet.markercluster-src.js"></script>
  <script src="offline/leaflet/plugins/MarkerClusterLayerSupport/layersupport.js"></script>
  <link rel="stylesheet" href="offline/leaflet/plugins/fullscreen/leaflet.fullscreen.css"/>
  <script src="offline/leaflet/plugins/fullscreen/Leaflet.fullscreen.js"></script>

  <!-- Local copies of Leaflet plugins not available via CDN -->
  <link rel="stylesheet" href="code/leaflet-plugins/ControlLayersTree/L.Control.Layers.Tree.css"/>
  <script src="code/leaflet-plugins/ControlLayersTree/L.Control.Layers.Tree.js"></script>
  <link rel="stylesheet" href="code/leaflet-plugins/defaultextent/leaflet.defaultextent.css"/>
  <script src="code/leaflet-plugins/defaultextent/leaflet.defaultextent.js"></script>
  <script src="code/leaflet-plugins/heat/leaflet-heat.js"></script>
  <script src="code/leaflet-plugins/heatlayercontrol.js"></script>

  <!-- Stylesheets, code, and data -->
  <link rel="stylesheet" href="code/map_stylesheet.css"/>
  <script src="code/map_functions.js"></script>
  <script src="code/map_classes.js"></script>
  <script src="data/geojson/ward_boundaries.js"></script>
  <script src="data/geojson/neighborhood_boundaries.js"></script>
  <!--script src="data/geojson/zoning_districts.js"></script-->
  <script src="data/geojson/school_locations.js"></script>
  <script src="data/misc/misc.js"></script>
  <script src="data/misc/individual_properties.js"></script>
  <script src="data/city-owned/city_owned_data.js"></script>
  <script src="data/tax-sale/taxsale_2019.js"></script>
  <script src="data/tax-sale/taxsale_2020.js"></script>
  <script src="data/scavenger-sale/scavenger_data.js"></script>
  <script src="data/business-licenses/business_license_data.js"></script>
  <script src="data/crime/crime_data.js"></script>

  <script>

    console.log("Starting inline script...");

    $("#pageHeader").html(`<h1>${document.title}</h1>`);

    // create map
    const map = L.map("map", {
      center: { lat: 41.79153671046777, lng: -87.62755393981935 },
      zoom: 13,
      scrollWheelZoom: false,
      zoomControl: false,
    });
    map.addControl(new L.Control.Fullscreen({
      title: {
        "false": "Enter fullscreen mode",
        "true": "Exit fullscreen mode",
      }
    }));
    map.addControl(L.control.zoom());
    const defaultExtentControl = L.control.defaultExtent({ position: "topleft" }).addTo(map);

    // add tiles to map - reference: https://leafletjs.com/examples/layers-control/
    const osmtiles = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "&copy; " + getOpenInNewTabLink("http://www.openstreetmap.org/copyright", "OpenStreetMap"),
    }).addTo(map);

    // marker cluster support group for all clusterable markers
    const markerClusterSupportGroup = L.markerClusterGroup.layerSupport({
      maxClusterRadius: 50,
    }).addTo(map);

    // popup that describes marker cluster content when user mouses over marker cluster
    markerClusterSupportGroup.on("clustermouseover", (a) => {
      a.layer.bindTooltip(
        getMarkerClusterTooltipContent(a.layer.getAllChildMarkers()),
      ).openTooltip();
    });

    const wardHighlightSelect = new HighlightSelect(
      "Choose a ward to highlight: ",
      "Select the ward that should be highlighted on the map",
      (props, comparand) => { return "ward" in props && ("Ward " + props.ward) === comparand },
    );
    for (let i = 1; i < 51; i++) { wardHighlightSelect.addOption("Ward " + i); }

    const neighborhoodHighlightSelect = new HighlightSelect(
      "Choose a neighborhood to highlight: ",
      "Select the neighborhood that should be highlighted on the map",
      (props, comparand) => { return "pri_neigh" in props && props.pri_neigh === comparand },
    );

    /*const zoneClassHighlightSelect = new HighlightSelect(
      "Choose a zone class to highlight: ",
      "Select the zone class that should be highlighted on the map",
      (props, comparand) => { return "zone_class" in props && props.zone_class.startsWith(comparand); },
    );*/

    // add geographic boundaries
    const geoBoundaries = new ChildLayerGroup("Geographic Boundaries");
    geoBoundaries.addChildLayer(new BoundaryLayerInfo(
      "Ward Boundaries (2015–2023)",
      ward_boundaries_2015_to_2023.data,
      ward_boundaries_2015_to_2023.metadata.attribution ? ward_boundaries_2015_to_2023.metadata.attribution : "City of Chicago",
      {
        getTooltipText: (props) => { return `Ward ${props.ward} (2015–2023)`; },
        highlightFunction: wardHighlightSelect.highlightFunction,
      },
    ));
    geoBoundaries.addChildLayer(new BoundaryLayerInfo(
      "Ward Boundaries (2023+)",
      ward_boundaries_2023.data,
      ward_boundaries_2023.metadata.attribution ? ward_boundaries_2023.metadata.attribution : "City of Chicago",
      {
        getTooltipText: (props) => { return `Ward ${props.ward} (2023+)`; },
        highlightFunction: wardHighlightSelect.highlightFunction,
      },
    ));
    geoBoundaries.addChildLayer(new BoundaryLayerInfo(
      "Neighborhood Boundaries",
      neighborhood_boundaries.data,
      neighborhood_boundaries.metadata.attribution ? neighborhood_boundaries.metadata.attribution : "City of Chicago",
      {
        getTooltipText: (props) => { return props.pri_neigh; },
        highlightFunction: neighborhoodHighlightSelect.highlightFunction,
        onEachFeature: (feature) => { neighborhoodHighlightSelect.addOption(feature.properties.pri_neigh); },
      },
    ));
    /*const zoneClassRegex = new RegExp("^[A-Z]+");
    geoBoundaries.addChildLayer(new BoundaryLayerInfo(
      "Zoning Districts",
      zoning_districts.data,
      zoning_districts.metadata.attribution ? zoning_districts.metadata.attribution : "City of Chicago",
      {
        getTooltipText: (props) => { return props.zone_class; },
        highlightFunction: zoneClassHighlightSelect.highlightFunction,
        onEachFeature: (feature) => { zoneClassHighlightSelect.addOption(zoneClassRegex.exec(feature.properties.zone_class)[0]); }, // add alphabetic zone class prefix
      }
    ));*/
    geoBoundaries.addChildLayer(new LayerInfo("No Boundaries", null, L.layerGroup(), false));
    map.addLayer(geoBoundaries.getChildLayer("Ward Boundaries (2015–2023)").layer);

    function getWard(ward) {
      return ward === 20 ? "Ward 20"
        : ward <= 10 ? "Wards 01–10"
        : ward < 20 ? "Wards 11–19"
        : ward <= 30 ? "Wards 21–30"
        : ward <= 40 ? "Wards 31–40"
        : ward <= 50 ? "Wards 41–50"
        : "Unknown Ward";
    }

    const favoritedMarkers = new FavoritedMarkerGroup("hei-map-favorited-markers");
  
    function getToggleFavoritedButton(markerData) {
      return $(`<button type='button'></button>`).addClass("toggleFavoritedButton")
        .text(favoritedMarkers.has(markerData) ? "Remove from Favorited Markers" : "Add to Favorited Markers")
        .data("markerData", markerData);
    }

    function getDataToDisplay(dataList) {
      return $("<span></span>").addClass("increasedLineHeight")
        .html(dataList.map((item) => `<span class='dataToDisplayLabel'>${item.label}</span>: ${item.data ? item.data : "unknown"}`).join("<br>"))
        .get(0);
    }
    const colorGenerator = new ColorGenerator();
    const getDefaultAutomaticClassificationOptions = (getListOfDataToDisplay) => {
      return {
        getLayerInfo: (name, attribution) => new LayerInfo(
          name,
          colorGenerator.getNextColor(),
          getCheckedInLayer(markerClusterSupportGroup, { attribution: attribution }),
          true,
        ),
        getMarkerPopupContent: getMarkerPopupContent,
        markerPopupContentOptions: {
          getDataToDisplay: (markerData) => getDataToDisplay(getListOfDataToDisplay(markerData)),
          getFormElementsToDisplay: (markerData) => getToggleFavoritedButton(markerData),
        },
      };
    };

    const sunshineGospel = new MarkerAndCircleDatagroup(
      "Sunshine Gospel Ministries",
      new Dataset(sunshine_gospel, property_locations_metadata.attribution, "pin"),
      {
        markerColor: "#ff66ff",
        circleColor: "#ff80ff",
        getMarkerPopupContent: getMarkerPopupContent,
        markerPopupContentOptions: {
          getDataToDisplay: (markerData) => {
            const data = markerData.data;
            return getDataToDisplay([
              { label: "Address", data: data.property_address },
              { label: "Website", data: getOpenInNewTabLink("https://www.sunshinegospel.org/") },
            ]);
          },
          getFormElementsToDisplay: (markerData) => getToggleFavoritedButton(markerData),
        },
      },
    );

    const ward20Office = new MarkerAndCircleDatagroup(
      "Ward 20 Office",
      new Dataset(ward_20_office, ward_offices_metadata.attribution, "ward"),
      {
        markerColor: "#0099ff",
        circleColor: "#00ace6",
        getMarkerPopupContent: getMarkerPopupContent,
        markerPopupContentOptions: {
          getDataToDisplay: (markerData) => {
            const data = markerData.data;
            return getDataToDisplay([
              { label: "Address", data: data.address },
              { label: "Website", data: getOpenInNewTabLink("https://www.chicago.gov/city/en/about/wards/20.html") },
            ]);
          },
          getFormElementsToDisplay: (markerData) => getToggleFavoritedButton(markerData),
        },
      },
    );

    const cityOwned = new AutomaticClassificationDatagroup(
      "City-Owned PINs (Possibly for Sale)",
      new Dataset(city_owned_data, city_owned_metadata.attribution + " & " + property_locations_metadata.attribution, "pin"),
      (data) => { return data.ward ? getWard(data.ward) : "Unknown Ward" },
      getDefaultAutomaticClassificationOptions(
        (markerData) => {
          const data = markerData.data;
          return [
            { label: "PIN", data: data.pin },
            { label: "Address", data: data.property_address },
            { label: "Ward", data: data.ward },
            { label: "Zip Code", data: data.property_zip },
            { label: "Date of Acquisition", data: data.date_of_acquisition },
            { label: "Record Last Updated", data: data.last_update },
            { label: "Property Details", data: getPropertyDetailsLink(data.pin) },
          ];
        }
      ),
    );

    const taxSale2019 = new AutomaticClassificationDatagroup(
      "Tax Sale for Tax Year 2019 in Ward 20",
      new Dataset(taxsale_2019_data, taxsale_2019_metadata.attribution + " & " + property_locations_metadata.attribution, "pin"),
      (data) => { return data.classification ? data.classification : "Unclassified" },
      getDefaultAutomaticClassificationOptions(
        (markerData) => {
          const data = markerData.data;
          return [
            { label: "PIN", data: data.pin },
            { label: "Address", data: data.property_address },
            { label: "Ward", data: data.ward },
            { label: "Classification", data: data.classification },
            { label: "2019 Tax Due (Including Interest)", data: `$${data.total_due_including_interest}` },
            { label: "2019 Tax Due (Excluding Interest)", data: `$${data.total_tax_due}` },
            { label: "Property Details", data: getPropertyDetailsLink(data.pin) },
          ];
        }
      ),
    );

    const taxSale2020 = new AutomaticClassificationDatagroup(
      "Tax Sale for Tax Year 2020 in Ward 20",
      new Dataset(taxsale_2020_data, taxsale_2020_metadata.attribution + " & " + property_locations_metadata.attribution, "pin"),
      (data) => { return data.classification ? data.classification : "Unclassified" },
      getDefaultAutomaticClassificationOptions(
        (markerData) => {
          const data = markerData.data;
          return [
            { label: "PIN", data: data.pin },
            { label: "Address", data: data.property_address },
            { label: "Ward", data: data.ward },
            { label: "Classification", data: data.classification },
            { label: "2020 Tax Due (Including Interest)", data: data.total_due_including_interest },
            { label: "2020 Tax Due (Excluding Interest)", data: data.total_tax_due },
            { label: "Property Details", data: getPropertyDetailsLink(data.pin) },
          ];
        }
      ),
    );

    const scavengerSale = new AutomaticClassificationDatagroup(
      "Scavenger Sale 2022 in Ward 20",
      new Dataset(scavenger_sale_data, scavenger_sale_metadata.attribution + " & " + property_locations_metadata.attribution, "pin"),
      (data) => { return data.property_code_class ? data.property_code_class : "Unclassified" },
      getDefaultAutomaticClassificationOptions(
        (markerData) => {
          const data = markerData.data;
          return [
            { label: "PIN", data: data.pin },
            { label: "Address", data: data.property_address },
            { label: "Zip Code", data: data.property_zip },
            { label: "Classification", data: data.property_code_meaning },
            { label: "Delinquent Tax Year Range", data: data.delinquent_tax_year_range },
            { label: "Delinquent Tax", data: `$${data.delinquent_tax}` },
            { label: "Delinquent Interest", data: `$${data.delinquent_interest}` },
            { label: "Property Details", data: getPropertyDetailsLink(data.pin) },
          ];
        }
      ),
    );

    const expandSchoolAbbreviation = function(abbrev) {
      abbreviations = { ES: "Elementary School", HS : "High School" };
      return abbrev in abbreviations ? abbreviations[abbrev] : abbrev;
    }
    const schoolLocations = new AutomaticClassificationDatagroup(
      "Chicago Public Schools (2021-2022)",
      new Dataset(
        school_locations.data.features,
        school_locations.metadata.attribution,
        (data) => data.properties.school_id,
        (data) => L.GeoJSON.coordsToLatLng(data.geometry.coordinates),
      ),
      (data) => {
        return data.properties.grade_cat
          ? expandSchoolAbbreviation(data.properties.grade_cat)
          : "Unknown Category";
      },
      getDefaultAutomaticClassificationOptions(
        (markerData) => {
          const data = markerData.data.properties;
          return [
            { label: "Name", data: data.short_name },
            { label: "Address", data: data.address },
            { label: "Type", data: expandSchoolAbbreviation(data.grade_cat) },
          ];
        }
      ),
    );

    const businessLicenses = new AutomaticClassificationDatagroup(
      "Business Licenses in Ward 20",
      new Dataset(business_license_data, business_licenses_metadata.attribution, "license_id"),
      (data) => {
        return data.license_description
          ? Array.isArray(data.license_description)
            ? "Multiple Licenses"
            : data.license_description.toString()
          : "Unknown License"
      },
      getDefaultAutomaticClassificationOptions(
        (markerData) => {
          const data = markerData.data;
          return [
            { label: "Business", data: data.doing_business_as_name },
            { label: "Address", data: data.address },
            { label: "Zip Code", data: data.zip_code },
            { label: "License Description(s)", data: joinArray(data.license_description, "; "), },
            { label: "Business Activities", data: joinArray(data.business_activity, "; "), },
          ];
        }
      ),
    );

    const crimes = new AutomaticClassificationDatagroup(
      "Crimes Within the Past Year in Ward 20",
      new Dataset(crime_data, crimes_metadata.attribution, "case_number"),
      (data) => {
        return data.primary_description ? data.primary_description: "Unknown Category"
      },
      getDefaultAutomaticClassificationOptions(
        (markerData) => {
          const data = markerData.data;
          return [
            { label: "Block Address", data: data.block },
            { label: "Date of Occurrence", data: data.date_of_occurrence },
            { label: "Primary Description", data: data.primary_description },
            { label: "Secondary Description", data: data.secondary_description, },
            { label: "Location Description", data: data.location_description, },
          ];
        }
      ),
    );

    const userAddedMarkers = new SearchResultsDatagroup(
      "User-Added Markers",
      new Dataset({}, property_locations_metadata.attribution, "pin"),
      "hei-map-user-search-results",
      {
        getLayerInfo: (name, attribution) => new LayerInfo(
          name,
          "red",
          getCheckedInLayer(markerClusterSupportGroup, { attribution: attribution }),
          false,
        ),
        getMarkerPopupContent: getMarkerPopupContent,
        markerPopupContentOptions: {
          getDataToDisplay: (markerData) => {
            const data = markerData.data;
            return getDataToDisplay([
              { label: "PIN", data: data.pin },
              { label: "Address", data: data.property_address },
              { label: "Zip Code", data: data.property_zip },
              { label: "City", data: data.property_city },
              { label: "Ward", data: data.ward },
              { label: "Property Details", data: getPropertyDetailsLink(data.pin) },
            ]);
          },
          getFormElementsToDisplay: (markerData) => [
            getToggleFavoritedButton(markerData),
            $("<button type='button'>Remove from Map</button>").addClass("removeSearchResultButton")
              .data("markerData", markerData),
          ],
        },
      },
    );

    const datagroups = [ward20Office, sunshineGospel, cityOwned, taxSale2019, taxSale2020, scavengerSale, schoolLocations, businessLicenses, crimes, userAddedMarkers];
    const datagroupOverlays = [];
    for (const datagroup of datagroups.sort((a, b) => compare(a.name, b.name))) {
      favoritedMarkers.registerDatagroup(datagroup);
      datagroupOverlays.push(getChildLayerGroupOverlaySubtree(
        datagroup,
        {
          selectAllCheckbox: true,
          sort: true,
          collapsed: true,
        }
      ));
    }

    // add overlay control tree
    const baseTree = {
      label: "Base Layers",
      children: [
        { label: "Open StreetMap", layer: osmtiles },
      ]
    };

    const overlayTree = [
      getChildLayerGroupOverlaySubtree(geoBoundaries, {
        radioGroupName: "geoboundaries",
        selectAllCheckbox: false,
      }),
      ...datagroupOverlays,
    ];

    const layerControlTree = L.control.layers.tree(
      baseTree,
      overlayTree,
      {
        collapsed : true,
        hideSingleBase: true,
        collapseAll: "<span class='leafOverlayLayer'>Collapse all</span>",
        expandAll: "<span class='leafOverlayLayer'>Expand all</span>",
      }
    ).addTo(map);

    const markerClusterLegend = getMarkerClusterLegend("bottomleft").addTo(map);

    const heatLayerControl = L.control.heatLayer({
      position: "topleft",
      datagroups: [cityOwned, taxSale2019, taxSale2020, scavengerSale, schoolLocations, businessLicenses, crimes, userAddedMarkers],
      getBottomOffset: () => {
        return 30 + (markerClusterLegend._container.offsetParent
          ? markerClusterLegend._container.offsetParent.clientHeight
          : 0);
      },
    }).addTo(map);
    
    $("#pinSearchBarDiv").append(
      getPinSearchBar(
        map,
        [ sunshineGospel, cityOwned, taxSale2019, taxSale2020, scavengerSale, userAddedMarkers, ],
        markerClusterSupportGroup,
        (data) => userAddedMarkers.addSearchResult(data),
      )
    );

    const highlightSelectItems = [
      { highlightSelect: wardHighlightSelect, sort: false, layerNames: ["Ward Boundaries (2015–2023)", "Ward Boundaries (2023+)"] },
      { highlightSelect: neighborhoodHighlightSelect, sort: true, layerNames: ["Neighborhood Boundaries"] },
      //{ highlightSelect: zoneClassHighlightSelect, sort: true, layerNames: ["Zoning Districts"] },
    ];
    const highlightSelectDiv = $("#highlightSelectDiv");
    for (const item of highlightSelectItems) {
      highlightSelectDiv.append(
        $("<div></div>").addClass("formContainer")
          .append(item.highlightSelect.getHighlightSelectElement(item.sort, item.layerNames.map((layerName) => geoBoundaries.getChildLayer(layerName))))
      );
    }

    const radiiInputItems = [ward20Office, sunshineGospel];
    const radiiInputDiv = document.getElementById("radiiInputDiv");
    for (const item of radiiInputItems) {
      radiiInputDiv.appendChild(item.getRadiusInputElement());
    }

    const additionalMapControlsDiv = $("#additionalMapControls");
    getToggleVisibilityButton(
      additionalMapControlsDiv, "+ Show Additional Map Controls", "- Hide Additional Map Controls", null,
    )
    .insertBefore(additionalMapControlsDiv.hide());

    const favoritedMarkersOverviewParagraph = $("#favoritedMarkersOverviewParagraph");
    const favoritedMarkersDetailsDiv = $("#favoritedMarkersDetailsDiv");
    const favoritedMarkersTableDiv = $("#favoritedMarkersTableDiv");
    favoritedMarkersTableDiv.on("click", ".showOnMapButton", (event) => {
      const markerData = $(event.target).data("markerData");
      $("#mapTabItem").trigger("click");
      showMarkerOnMap(map, markerData, markerClusterSupportGroup);
    });
    function generateFavoritedMarkersContent() {
      const numFavoritedMarkers = favoritedMarkers.size();
      favoritedMarkersOverviewParagraph.text(`You have ${numFavoritedMarkers} Favorited Marker${numFavoritedMarkers === 1 ? "" : "s"}.`);
      if (numFavoritedMarkers > 0) {
        favoritedMarkersTableDiv.html(generateFavoritedMarkersTable(favoritedMarkers.getAll()));
        favoritedMarkersDetailsDiv.show(0);
      } else {
        favoritedMarkersDetailsDiv.hide(0);
      }
    }

    $("#tabDiv").append(getTabs([
      { label: "Map", id: "mapTabItem", tabContent: $("#mapTab"
      ), callback: () => map.invalidateSize(false), initiallyActive: true },
      { label: "About This Map", id: "aboutMapTabItem", tabContent: $("#aboutMapTab"), },
      {
        label: "Favorited Markers",
        id: "favoritedMarkersTabItem",
        tabContent: $("#favoritedMarkersTab"),
        callback: generateFavoritedMarkersContent,
      },
    ]));

    $("#aboutMapTab")
      .append([
        `<p class='italic'>This is a map of properties that may be of interest to Sunshine Gospel Ministries' ${getOpenInNewTabLink("https://www.sunshinegospel.org/hei/", "Housing Equity Initiative")} (HEI). This map was created by Claire Wagner, a member of the Wheaton College Summer 2022 Research Team.</p>`,
        generatePluginsAttribution([
          { name: "Leaflet.markercluster", link: "https://github.com/Leaflet/Leaflet.markercluster", license: "MIT License" },
          { name: "Leaflet.MarkerCluster.LayerSupport", link: "https://github.com/ghybs/Leaflet.MarkerCluster.LayerSupport", license: "MIT License" },
          { name: "Leaflet.Control.Layers.Tree", link: "https://github.com/jjimenezshaw/Leaflet.Control.Layers.Tree", license: "BSD 3-Clause License"},
          { name: "Leaflet.fullscreen", link: "https://github.com/Leaflet/Leaflet.fullscreen", license: "ISC License" },
          { name: "Leaflet.defaultextent", link: "https://github.com/nguyenning/Leaflet.defaultextent", license: "MIT License", modified: true, },
          { name: "Leaflet.heat", link: "https://github.com/Leaflet/Leaflet.heat", license: "BSD 2-Clause \"Simplified\" License" },
        ], "italic"),
        generateMetadataTable(
          "Data Used in This Map",
          [
            property_locations_metadata,
            ward_offices_metadata,
            city_owned_metadata,
            taxsale_2019_metadata,
            taxsale_2020_metadata,
            scavenger_sale_metadata,
            property_classification_codes_metadata,
            business_licenses_metadata,
            crimes_metadata,
            school_locations.metadata,
            ward_boundaries_2015_to_2023.metadata,
            ward_boundaries_2023.metadata,
            neighborhood_boundaries.metadata,
            //zoning_districts.metadata,        
          ],
        )
      ]);

    $(".leaflet-popup-pane")
      .on("click", ".toggleFavoritedButton", (event) => {
        const target = $(event.target);
        const markerData = target.data("markerData");
        if (favoritedMarkers.has(markerData)) {
          favoritedMarkers.remove(markerData);
          target.text("Add to Favorited Markers");
        } else {
          favoritedMarkers.add(markerData);
          target.text("Remove from Favorited Markers");
        }
      })
      .on("click", ".removeSearchResultButton", (event) => {
        const markerData = $(event.target).data("markerData");
        userAddedMarkers.removeSearchResult(
          markerData,
          (markerData) => favoritedMarkers.remove(markerData), // remove from Favorited Markers if favorited
        );
      });
    
    $("#favoritedMarkersButtonsDiv").append([
      $("<button type='button'>Delete All Favorited Markers</button>")
        .attr("title", "Permanently delete all Favorited Markers")
        .on("click", (event) => {
          if (favoritedMarkers.size() > 0 && window.confirm("Are you sure you want to delete all of your Favorited Markers?")) {
            favoritedMarkers.removeAll();
            generateFavoritedMarkersContent();
          }
        }),
      $("<button type='button'>Export All Favorited Markers</button>")
        .attr("title", "Export all Favorited Markers in JSON format")
        .on("click", (event) => {
          const toExport = JSON.stringify(
            favoritedMarkers.getAll().map((markerData) => {
              return {
                category: markerData.datagroup.name,
                subcategory: markerData.layerInfo.name,
                data: markerData.data,
              }
            })
          );
          downloadDataAsFile(toExport, "favorited_markers.json", "application/json");
        }),
    ]);
    
    console.log("Ending inline script");
    
  </script>

  <script>
    // restore favorited markers from local storage
    const numSaved = favoritedMarkers.localStorageSize();
    if (numSaved > 0) {
      if (window.confirm(`You have ${numSaved} Favorited Marker${numSaved === 1 ? " that was" : "s that were"} saved during your previous session. Do you want to keep ${numSaved === 1 ? "it" : "them"}?`)) {
        favoritedMarkers.restoreFromLocalStorage();
      } else {
        favoritedMarkers.removeFromLocalStorage();
      }
    }
    $("#loadingDiv").hide();
    $("#pageContent").show(0, () => {
      map.invalidateSize(false);
    });
  </script>

</body>

</html>

<!-- references:
  https://github.com/Leaflet/Leaflet/tree/main/docs/examples (BSD 2-Clause license)
-->
